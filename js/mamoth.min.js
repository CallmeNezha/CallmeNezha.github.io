//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 6/3/2016  All rights reserved by @NeZha

(function(){var g,t,x,c,z,B,a,n,m,p,d,j,s,l,k,b,u,i,A,e,q,r,v,w,h,o,y,f;f="varying vec3 vWorldPosition;\n\nvoid main() {\n\n	vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n	vWorldPosition = worldPosition.xyz;\n\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}";a="uniform vec3 topColor;\nuniform vec3 bottomColor;\nuniform float offset;\nuniform float exponent;\n\nvarying vec3 vWorldPosition;\n\nvoid main() {\n\n	float h = normalize( vWorldPosition + offset ).y;\n	gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );\n\n}";p=function(){var C;C=new Stats();C.setMode(0);return C};m=function(){var C,D,E;E=new THREE.Scene();C=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,5001);C.position.x=300;C.position.y=180;C.position.z=300;C.position.multiplyScalar(1.7);C.lookAt(E.position);D=new THREE.WebGLRenderer({antialias:true});D.setPixelRatio(window.devicePixelRatio);D.setClearColor(0);D.setSize(window.innerWidth,window.innerHeight);D.shadowMap.enabled=true;return{scene:E,camera:C,renderer:D}};y=p();i=m(),w=i.scene,t=i.camera,r=i.renderer;document.getElementById("stats-output").appendChild(y.domElement);document.getElementById("webgl-output").appendChild(r.domElement);j=new THREE.OrbitControls(t,r.domElement);j.maxDistance=1000;j.minDistance=200;j.minPolarAngle=Math.PI/4;j.maxPolarAngle=Math.PI/2;j.center=new THREE.Vector3(0,150,0);h=new THREE.SpotLight(16777215,1);h.position.set(15,40,35);h.position.multiplyScalar(20);h.castShadow=true;h.angle=Math.PI/3;h.penumbra=0.25;h.decay=1;h.distance=2000;h.shadow.mapSize.width=2048*2;h.shadow.mapSize.height=2048*2;h.shadow.camera.near=1;h.shadow.camera.far=2000;w.add(h);v=new THREE.MeshPhongMaterial({color:16777215,specular:328965});v.color.setHSL(0.095,1,0.75);l=new THREE.CircleGeometry(2000,16);k=v;b=new THREE.Mesh(l,k);b.position.set(0,0,0);b.rotation.x=-Math.PI/2;b.receiveShadow=true;w.add(b);x=new THREE.CTMLoader();x.load("../models/mammoth.ctm",function(E){var C,D;D=new THREE.MeshLambertMaterial({color:13289392});C=new THREE.Mesh(E,D);C.rotation.x=-Math.PI/2;C.position.set(0,170,350);C.castShadow=true;w.add(C);return document.getElementById("loading").style.display="none"},{useWorker:true});r.gammaInput=true;r.gammaOutput=true;u={ssao_enabled:true,render_mode:0};q=new THREE.RenderPass(w,t);c=new THREE.MeshDepthMaterial();c.depthPacking=THREE.RGBADepthPacking;c.blending=THREE.NoBlending;s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter};z=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,s);o=new THREE.ShaderPass(THREE.SSAOShader);o.renderToScreen=true;o.uniforms["tDepth"].value=z.texture;o.uniforms["size"].value.set(window.innerWidth,window.innerHeight);o.uniforms["cameraNear"].value=t.near;o.uniforms["cameraFar"].value=t.far;o.uniforms["onlyAO"].value=u.renderMode===1;o.uniforms["aoClamp"].value=0.3;o.uniforms["lumInfluence"].value=0.5;B=new THREE.EffectComposer(r);B.addPass(q);B.addPass(o);e=function(C){switch(C){case"0":u.ssao_enabled=true;return o.uniforms["onlyAO"].value=false;case"1":u.ssao_enabled=false;return o.uniforms["onlyAO"].value=false;case"2":u.ssao_enabled=true;return o.uniforms["onlyAO"].value=true;default:return console.error("Not define renderModeChange type: "+C)}};n=new dat.GUI();n.add(u,"render_mode",{ssao:0,orignal:1,aobuffer:2}).onChange(e).listen();A=function(){if(u.ssao_enabled===true){w.overrideMaterial=c;r.render(w,t,z,true);w.overrideMaterial=null;return B.render()}else{return r.render(w,t)}};(g=function(){var C;requestAnimationFrame(g);C=Date.now();j.update();A();return y.update()})();d=function(){var C,D;t.aspect=window.innerWidth/window.innerHeight;t.updateProjectionMatrix();r.setSize(window.innerWidth,window.innerHeight);o.uniforms["size"].value.set(window.innerWidth,window.innerHeight);D=Math.floor(window.innerWidth/window.devicePixelRatio)||1;C=Math.floor(window.innerHeight/window.devicePixelRatio)||1;z.setSize(D,C);return B.setSize(D,C)};window.addEventListener("resize",d,false)}).call(this);