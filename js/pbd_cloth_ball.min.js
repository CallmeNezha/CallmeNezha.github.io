//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 5/27/2016  All rights reserved by @NeZha

(function(){var G,g,a,E,m,n,t,u,w,j,d,I,y,A,B,e,l,F,s,i,p,x,o,q,f,c,v,k,H,r,C,D,z,b;s={lerp:function(J,K,h){if((1>=h&&h>=0)){return(K-J)*h+J}if(h<0){return J}if(h>1){return K}},swap:function(J,h){var K;K=J;J=h;return h=K},bendStiff:0.1,bendRest:0.3,wireframe:true};g=0.03;a=1-0.03;b={windForce:new THREE.Vector3(0,5,1)};t=18/1000;n=1;i=new THREE.Vector3(0,-98,0);v=[{index:[0,0],position:[-50,50,0]},{index:[40,0],position:[50,50,0]},{index:[1640,0],position:[-50,50,180]},{index:[1680,0],position:[50,50,180]},{index:[11,11],position:[0,50,60]},{index:[20,11],position:[20,50,70]},{index:[11,22],position:[-30,50,90]},{index:[20,22],position:[-20,50,100]}];G=(function(){function h(K,J,L){this.position=new THREE.Vector3().copy(K);this.previous=new THREE.Vector3().copy(K);this.radius=J;this.mass=L;this.invmass=L===0?0:1/L;this.a=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3()}h.prototype.addForce=function(J){this.tmp.copy(J).multiplyScalar(this.invmass);return this.a.add(this.tmp)};h.prototype.integrate=function(J){var K;this.tmp2.subVectors(this.position,this.previous);K=this.tmp2.add(this.a.multiplyScalar(J*J)).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=K;return this.a.set(0,0,0)};h.prototype.simulate=function(K){var J;J=new THREE.Vector3().copy(i);J.multiplyScalar(this.mass);this.addForce(J);return this.integrate(K)};return h})();m=(function(){function h(J,M,L,K){this.previous=new THREE.Vector3(J,M,L);this.position=new THREE.Vector3(J,M,L);this.original=new THREE.Vector3(J,M,L);this.velocity=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3();this.mass=K!=null?K:0;this.invmass=this.mass===0?0:1/this.mass;this.a=new THREE.Vector3(0,0,0)}h.prototype.addForce=function(J){this.tmp.copy(J).multiplyScalar(this.invmass);return this.a.add(this.tmp)};h.prototype.integrate=function(J,K){var L;L=this.tmp2;this.velocity.add(this.a.multiplyScalar(J));L.copy(this.velocity).multiplyScalar(K*J).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=L;return this.a.set(0,0,0)};return h})();E=(function(){h.prototype.particleMass=0.1;h.prototype.lastTime=void 0;function h(J,ad,S,T){var M,L,ac,ab,aa,Z,Y,X,W,K,V,U,Q,O,N,R,P;this.faces=void 0;this.ws=ad;this.hs=S;this.particles=[];this.planeFunc=this.plane(J,ad,S);this.collisionProxy=void 0;this.constrains=[];this.diff=new THREE.Vector3();this.nagdiff=new THREE.Vector3();this.bendConstrains=[];for(P=ac=0,K=S;0<=K?ac<=K:ac>=K;P=0<=K?++ac:--ac){for(R=ab=0,V=ad;0<=V?ab<=V:ab>=V;R=0<=V?++ab:--ab){X=this.planeFunc(R/ad,P/S);this.particles.push(new m(X.x,X.y,X.z,this.particleMass))}}for(P=aa=0,U=S-1;0<=U?aa<=U:aa>=U;P=0<=U?++aa:--aa){for(R=Z=0,Q=ad-1;0<=Q?Z<=Q:Z>=Q;R=0<=Q?++Z:--Z){M=this.index(R,P);L=this.index(R,P+1);this.constrains.push([this.particles[M],this.particles[L],J]);this.constrains.push([this.particles[this.index(R,P)],this.particles[this.index(R+1,P)],J])}}R=ad;for(P=Y=0,O=S-1;0<=O?Y<=O:Y>=O;P=0<=O?++Y:--Y){this.constrains.push([this.particles[this.index(R,P)],this.particles[this.index(R,P+1)],J])}P=S;for(R=W=0,N=ad-1;0<=N?W<=N:W>=N;R=0<=N?++W:--W){this.constrains.push([this.particles[this.index(R,P)],this.particles[this.index(R+1,P)],J])}}h.prototype.simulate=function(aA){var ag,af,ao,N,al,ar,aM,aJ,aG,aD,aC,at,aS,aE,Z,ay,aw,aX,aj,aL,aK,aI,aT,ah,U,T,S,R,Q,P,O,aH,aF,am,ak,av,aB,aU,aR,aQ,aP,M,L,K,J,ai,aW,an,az,ax,au,ae,ad,ac,Y,X,W,V,aO,aN,aV,aq,ap;aV=new THREE.Vector3();if(this.faces==null){console.warn("clothFaces not assigned!")}if((b!=null)&&(this.faces!=null)){au=this.faces;for(aK=0,ah=au.length;aK<ah;aK++){Z=au[aK];av=Z.normal;aV.copy(av).normalize().multiplyScalar(av.dot(b.windForce));this.particles[Z.a].addForce(aV);this.particles[Z.b].addForce(aV);this.particles[Z.c].addForce(aV)}}aX=new THREE.Vector3().copy(i);aX.multiplyScalar(this.particleMass);ae=this.particles;for(aI=0,U=ae.length;aI<U;aI++){ai=ae[aI];ai.addForce(aX);ai.integrate(aA,a)}for(aL=aH=0;aH<1;aL=++aH){if(this.collisionProxy!=null){N=this.collisionProxy;for(aF=0,T=N.length;aF<T;aF++){ao=N[aF];ad=this.particles;for(aB=0,S=ad.length;aB<S;aB++){ai=ad[aB];this.applyBallContact(ai,ao)}ac=this.constrains;for(az=0,R=ac.length;az<R;az++){aM=ac[az];this.applyConstrains(aM[0],aM[1],aM[2],aL)}}for(ax=0,Q=v.length;ax<Q;ax++){an=v[ax];if(an.index==null){continue}Y=an.index,aq=Y[0],ap=Y[1];ai=this.particles[this.index(aq,ap)];if(an.position!=null){ai.position.set(an.position[0],an.position[1],an.position[2])}else{ai.position.copy(ai.original);ai.previous.copy(ai.original)}}X=this.particles;for(ag=0,P=X.length;ag<P;ag++){ai=X[ag];if(ai.position.y<-10){ai.position.y=-10}}ar=new THREE.Vector3();aS=new THREE.Vector3();am=new THREE.Vector3();ak=new THREE.Vector3();aJ=new THREE.Vector3();aG=new THREE.Vector3();aD=new THREE.Vector3();aC=new THREE.Vector3();W=this.bendConstrains;for(af=0,O=W.length;af<O;af++){al=W[af];ay=al[0],aw=al[1],M=al[2],L=al[3],J=al[4],K=al[5];V=[M.position,L.position,K.position,J.position],aU=V[0],aR=V[1],aQ=V[2],aP=V[3];
    aS.subVectors(aP,aQ);aE=aS.length();if(aE<0.000001){continue}aj=1/aE;aO=new THREE.Vector3();aN=new THREE.Vector3();aO.subVectors(aP,aU);am.subVectors(aQ,aU).cross(aO);am.divideScalar(am.lengthSq());aO.subVectors(aQ,aR);ak.subVectors(aP,aR).cross(aO);ak.divideScalar(ak.lengthSq());aJ.copy(am).multiplyScalar(aE);aG.copy(ak).multiplyScalar(aE);aO.copy(am);aD.copy(aO.multiplyScalar(aD.subVectors(aU,aP).dot(aS)*aj));aO.copy(ak);aD.add(aO.multiplyScalar(aN.subVectors(aR,aP).dot(aS)*aj));aO.copy(am);aC.copy(aO.multiplyScalar(aC.subVectors(aQ,aU).dot(aS)*aj));aO.copy(ak);aC.add(aO.multiplyScalar(aN.subVectors(aQ,aR).dot(aS)*aj));am.normalize();ak.normalize();at=am.dot(ak);if(at<-1){at=-1}if(at>1){at=1}aW=Math.acos(at);aT=M.invmass*aJ.lengthSq()+L.invmass*aG.lengthSq()+K.invmass*aD.lengthSq()+J.invmass*aC.lengthSq();if(aT===0){continue}aT=(aW-s.bendRest)/aT*s.bendStiff;if(am.cross(ak).dot(aS)>0){aT=-aT}aU.add(aJ.multiplyScalar(-aT*M.invmass));aR.add(aG.multiplyScalar(-aT*L.invmass));aQ.add(aD.multiplyScalar(-aT*K.invmass));aP.add(aC.multiplyScalar(-aT*J.invmass))}}}return this.estimateNewVelocity(aA)};h.prototype.applyBallContact=function(O,N){var J,K,L,M;this.diff.subVectors(O.position,N.position);M=this.diff.lengthSq();if(M>N.radius*N.radius){return}M=Math.sqrt(M);J=this.diff.multiplyScalar(1-N.radius/M);K=J.multiplyScalar(this.particleMass/(N.mass+this.particleMass));N.position.add(K);L=J.multiplyScalar(N.mass/this.particleMass);return O.position.sub(L)};h.prototype.applyConstrains=function(N,O,P,M){var J,K,L;this.diff.subVectors(N.position,O.position);L=this.diff.length();if(L===0){return}J=this.diff.multiplyScalar(1-P/L);K=J.multiplyScalar(0.5).multiplyScalar(1-Math.pow(1-n,1/(M+1)));O.position.add(K);return N.position.sub(K)};h.prototype.estimateNewVelocity=function(L){var K,J,O,N,M;N=this.particles;M=[];for(K=0,J=N.length;K<J;K++){O=N[K];M.push(O.velocity.subVectors(O.position,O.previous).multiplyScalar(1/L))}return M};h.prototype.plane=function(M,K,N){var L,J;J=K*M;L=N*M;return function(P,O){var R,Q;R=s.lerp(-J/2,J/2,P);Q=s.lerp(L/2,3*L/2,O);return new THREE.Vector3(R,Q,0)}};h.prototype.index=function(K,J){return K+J*(this.ws+1)};h.prototype.setFaces=function(M){var R,P,U,S,Q,O,N,L,J,K,Y,X,W,V,T;this.faces=M;for(S=Q=0,K=this.hs-1;0<=K?Q<=K:Q>=K;S=0<=K?++Q:--Q){for(U=O=0,Y=this.ws-1;0<=Y?O<=Y:O>=Y;U=0<=Y?++O:--O){R=this.faces[U*2+S*this.ws*2];P=this.faces[U*2+1+S*this.ws*2];this.bendConstrains.push([R,P,this.particles[R.a],this.particles[P.b],this.particles[R.b],this.particles[R.c]])}}for(S=N=0,X=this.hs-1;0<=X?N<=X:N>=X;S=0<=X?++N:--N){for(U=L=0,W=this.ws-2;0<=W?L<=W:L>=W;U=0<=W?++L:--L){R=this.faces[U*2+1+S*this.ws*2];P=this.faces[U*2+2+S*this.ws*2];this.bendConstrains.push([R,P,this.particles[R.c],this.particles[P.b],this.particles[R.a],this.particles[R.b]])}}T=[];for(U=J=0,V=this.ws-1;0<=V?J<=V:J>=V;U=0<=V?++J:--J){T.push((function(){var aa,ab,Z;Z=[];for(S=aa=0,ab=this.hs-2;0<=ab?aa<=ab:aa>=ab;S=0<=ab?++aa:--aa){R=this.faces[U*2+1+S*this.ws*2];P=this.faces[U*2+(S+1)*this.ws*2];Z.push(this.bendConstrains.push([R,P,this.particles[R.a],this.particles[P.c],this.particles[P.a],this.particles[P.b]]))}return Z}).call(this))}return T};return h})();c=function(){y.aspect=window.innerWidth/window.innerHeight;y.updateProjectionMatrix();return r.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",c,false);q=function(){var h;h=new Stats();h.setMode(0);return h};o=function(){var h,J,K;K=new THREE.Scene();h=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);h.position.x=-300;h.position.y=400;h.position.z=300;h.position.multiplyScalar(0.6);h.lookAt(new THREE.Vector3(50,0,50));J=new THREE.WebGLRenderer({antialias:true});J.setPixelRatio(window.devicePixelRatio);J.setClearColor(15658734);J.setSize(window.innerWidth,window.innerHeight);J.shadowMap.enabled=true;return{scene:K,camera:h,renderer:J}};D=q();document.getElementById("stats-output").appendChild(D.domElement);k=o(),C=k.scene,y=k.camera,r=k.renderer;document.body.appendChild(r.domElement);C.add(new THREE.AmbientLight(6710886));f=new THREE.DirectionalLight(14674943,0.8);f.position.set(50,200,100);f.castShadow=true;f.shadow.camera.near=2;f.shadow.camera.far=300;f.shadow.camera.left=-300;f.shadow.camera.right=300;f.shadow.camera.top=300;f.shadow.camera.bottom=-300;f.shadow.mapSize.width=800;f.shadow.mapSize.height=800;C.add(f);A=new E(3,40,40);l=new THREE.MeshLambertMaterial({color:2274815,side:THREE.DoubleSide});B=new THREE.MeshBasicMaterial({color:2274815,wireframe:true});e=new THREE.ParametricGeometry(A.planeFunc,A.ws,A.hs);A.setFaces(e.faces);F=THREE.SceneUtils.createMultiMaterialObject(e,[l,B]);F.position.set(0,0,0);F.children[0].receiveShadow=true;C.add(F);u=function(J,h){var N,L,K,M;K=new THREE.Vector3();K.subVectors(J.position,h.position);M=K.length();L=J.radius+h.radius;if(M>L){return}K.multiplyScalar(1-L/M);N=K.multiplyScalar(0.5);J.position.sub(N);return h.position.add(N)};d=[];I=[];j=new THREE.MeshLambertMaterial({color:9132544});
    (s.tossBalls=function(){var h,Q,O,N,K,J,L,M,P;C.remove.apply(C,d);I=[];d=[];K=10;O=15;h=5;for(P=L=0,M=h-1;0<=M?L<=M:L>=M;P=0<=M?++L:--L){J=new THREE.Vector3(-25+P*15,200,55+P*15);I.push(new G(J,K,O));Q=new THREE.SphereGeometry(K,32,32);N=new THREE.Mesh(Q,j);N.position.copy(J);N.castShadow=true;N.receiveShadow=true;d.push(N)}C.add.apply(C,d);return A.collisionProxy=I})();p=new dat.GUI();p.add(s,"wireframe").onChange().listen();x=p.addFolder("Wind Force");x.add(b.windForce,"x",-10,20);x.add(b.windForce,"y",-10,20);x.add(b.windForce,"z",-10,20);x.open();x=p.addFolder("Cloth Coefficient");x.add(s,"bendRest",0,Math.PI*0.1);x.add(s,"bendStiff",0,0.3);p.add(s,"tossBalls");w=new THREE.AxisHelper(20);C.add(w);z=function(){return s.wireframe=false};setTimeout(z,4000);H=function(){var h,O,M,L,K,S,N,J,R,T,Q,P;A.simulate(t);T=A.particles;for(O=L=0,S=T.length;L<S;O=++L){R=T[O];e.vertices[O].copy(R.position)}e.computeFaceNormals();e.computeVertexNormals();e.normalsNeedUpdate=true;e.verticesNeedUpdate=true;B.wireframe=s.wireframe;for(O=K=0,N=I.length;K<N;O=++K){h=I[O];d[O].position.copy(h.position);for(M=J=Q=O,P=I.length;Q<=P?J<P:J>P;M=Q<=P?++J:--J){if(M===O){continue}u(I[O],I[M]);d[O].position.copy(I[O].position);d[M].position.copy(I[M].position)}h.simulate(t)}D.update();requestAnimationFrame(H);return r.render(C,y)};document.getElementById("loading").style.display="none";H()}).call(this);