/**
 * Created by Nezha on 2016/5/24.
 */
(function(){var z,P,y,G,o,i,B,g,J,v,d,u,w,N,j,O,b,c,F,M,R,H,e,x,f,E,K,q,n,l,k,C,D,A,Q,a,L,I,s,r,p,m,V,U,T,S;c={lerp:function(W,X,h){if((1>=h&&h>=0)){return(X-W)*h+W}if(h<0){return W}if(h>1){return X}},swap:function(t,h){var W;W=t;t=h;return h=W},bendStiff:0.1,bendRest:0.3,wireframe:true};P=0.03;y=1-0.03;I={windForce:new THREE.Vector3(0,5,1)};B=18/1000;i=1;F=new THREE.Vector3(0,-98,0);L=0;K=[Math.cos(L)*100,Math.sin(L)*100+90],s=K[0],V=K[1];q=[Math.cos(L+Math.PI/2)*100,Math.sin(L+Math.PI/2)*100+90],r=q[0],U=q[1];n=[Math.cos(L+Math.PI)*100,Math.sin(L*Math.PI)*100+90],p=n[0],T=n[1];l=[Math.cos(L+Math.PI/2*3)*100,Math.sin(L*Math.PI/2*3)*100+90],m=l[0],S=l[1];E=[{index:[0,0],position:[-50,50,0]},{index:[40,0],position:[50,50,0]},{index:[1640,0],position:[-50,50,180]},{index:[1680,0],position:[50,50,180]},{index:[11,11],position:[0,50,60]},{index:[20,11],position:[20,50,70]},{index:[11,22],position:[-30,50,90]},{index:[20,22],position:[-20,50,100]}];z=(function(){function h(W,t,X){this.position=new THREE.Vector3().copy(W);this.previous=new THREE.Vector3().copy(W);this.radius=t;this.mass=X;this.invmass=X===0?0:1/X;this.a=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3()}h.prototype.addForce=function(t){this.tmp.copy(t).multiplyScalar(this.invmass);return this.a.add(this.tmp)};h.prototype.integrate=function(t){var W;this.tmp2.subVectors(this.position,this.previous);W=this.tmp2.add(this.a.multiplyScalar(t*t)).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=W;return this.a.set(0,0,0)};h.prototype.simulate=function(W){var t;t=new THREE.Vector3().copy(F);t.multiplyScalar(this.mass);this.addForce(t);return this.integrate(W)};return h})();o=(function(){function h(t,Y,X,W){this.previous=new THREE.Vector3(t,Y,X);this.position=new THREE.Vector3(t,Y,X);this.original=new THREE.Vector3(t,Y,X);this.velocity=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3();this.mass=W!=null?W:0;this.invmass=this.mass===0?0:1/this.mass;this.a=new THREE.Vector3(0,0,0)}h.prototype.addForce=function(t){this.tmp.copy(t).multiplyScalar(this.invmass);return this.a.add(this.tmp)};h.prototype.integrate=function(t,W){var X;X=this.tmp2;this.velocity.add(this.a.multiplyScalar(t));X.copy(this.velocity).multiplyScalar(W*t).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=X;return this.a.set(0,0,0)};return h})();G=(function(){h.prototype.particleMass=0.1;h.prototype.lastTime=void 0;function h(t,ap,ag,ah){var X,W,ao,an,am,al,ak,aj,ai,ad,ac,ab,aa,Z,Y,af,ae;this.faces=void 0;this.ws=ap;this.hs=ag;this.particles=[];this.planeFunc=this.plane(t,ap,ag);this.collisionProxy=void 0;this.constrains=[];this.diff=new THREE.Vector3();this.bendConstrains=[];for(ae=ao=0,ad=ag;0<=ad?ao<=ad:ao>=ad;ae=0<=ad?++ao:--ao){for(af=an=0,ac=ap;0<=ac?an<=ac:an>=ac;af=0<=ac?++an:--an){aj=this.planeFunc(af/ap,ae/ag);this.particles.push(new o(aj.x,aj.y,aj.z,this.particleMass))}}for(ae=am=0,ab=ag-1;0<=ab?am<=ab:am>=ab;ae=0<=ab?++am:--am){for(af=al=0,aa=ap-1;0<=aa?al<=aa:al>=aa;af=0<=aa?++al:--al){X=this.index(af,ae);W=this.index(af,ae+1);this.constrains.push([this.particles[X],this.particles[W],t]);this.constrains.push([this.particles[this.index(af,ae)],this.particles[this.index(af+1,ae)],t])}}af=ap;for(ae=ak=0,Z=ag-1;0<=Z?ak<=Z:ak>=Z;ae=0<=Z?++ak:--ak){this.constrains.push([this.particles[this.index(af,ae)],this.particles[this.index(af,ae+1)],t])}ae=ag;for(af=ai=0,Y=ap-1;0<=Y?ai<=Y:ai>=Y;af=0<=Y?++ai:--ai){this.constrains.push([this.particles[this.index(af,ae)],this.particles[this.index(af+1,ae)],t])}}h.prototype.simulate=function(aK){var ar,aq,aA,Z,ax,aD,aW,aT,aQ,aN,aM,aE,a2,aO,ap,aI,aG,a9,av,aV,aU,aS,a3,at,ak,ai,ag,af,ae,ad,ac,aR,aP,ay,aw,aF,aL,a5,a1,a0,aZ,Y,X,W,t,au,a8,az,aJ,aH,a6,a4,ao,an,am,al,aj,ah,aY,aX,a7,aC,aB;a7=new THREE.Vector3();if(this.faces==null){console.warn("clothFaces not assigned!")}if((I!=null)&&(this.faces!=null)){ao=this.faces;for(aU=0,at=ao.length;aU<at;aU++){ap=ao[aU];aF=ap.normal;a7.copy(aF).normalize().multiplyScalar(aF.dot(I.windForce));this.particles[ap.a].addForce(a7);this.particles[ap.b].addForce(a7);this.particles[ap.c].addForce(a7)}}a9=new THREE.Vector3().copy(F);a9.multiplyScalar(this.particleMass);an=this.particles;for(aS=0,ak=an.length;aS<ak;aS++){au=an[aS];au.addForce(a9);au.integrate(aK,y)}for(aV=aR=0;aR<2;aV=++aR){if(this.collisionProxy!=null){Z=this.collisionProxy;for(aP=0,ai=Z.length;aP<ai;aP++){aA=Z[aP];am=this.particles;for(aL=0,ag=am.length;aL<ag;aL++){au=am[aL];this.applyBallContact(au,aA)}al=this.constrains;for(aJ=0,af=al.length;aJ<af;aJ++){aW=al[aJ];this.applyConstrains(aW[0],aW[1],aW[2],aV)}}for(aH=0,ae=E.length;aH<ae;aH++){az=E[aH];if(az.index==null){continue}aj=az.index,aC=aj[0],aB=aj[1];au=this.particles[this.index(aC,aB)];if(az.position!=null){au.position.set(az.position[0],az.position[1],az.position[2])}else{au.position.copy(au.original);au.previous.copy(au.original)}}ah=this.particles;for(ar=0,ad=ah.length;ar<ad;ar++){au=ah[ar];if(au.position.y<-10){au.position.y=-10}}aD=new THREE.Vector3();a2=new THREE.Vector3();ay=new THREE.Vector3();aw=new THREE.Vector3();aT=new THREE.Vector3();aQ=new THREE.Vector3();aN=new THREE.Vector3();aM=new THREE.Vector3();a6=this.bendConstrains;for(aq=0,ac=a6.length;aq<ac;aq++){ax=a6[aq];aI=ax[0],aG=ax[1],Y=ax[2],X=ax[3],t=ax[4],W=ax[5];a4=[Y.position,X.position,W.position,t.position],a5=a4[0],a1=a4[1],a0=a4[2],aZ=a4[3];a2.subVectors(aZ,a0);aO=a2.length();if(aO<0.000001){continue}av=1/aO;aY=new THREE.Vector3();aX=new THREE.Vector3();aY.subVectors(aZ,a5);ay.subVectors(a0,a5).cross(aY);ay.divideScalar(ay.lengthSq());aY.subVectors(a0,a1);aw.subVectors(aZ,a1).cross(aY);aw.divideScalar(aw.lengthSq());aT.copy(ay).multiplyScalar(aO);aQ.copy(aw).multiplyScalar(aO);aY.copy(ay);aN.copy(aY.multiplyScalar(aN.subVectors(a5,aZ).dot(a2)*av));aY.copy(aw);aN.add(aY.multiplyScalar(aX.subVectors(a1,aZ).dot(a2)*av));aY.copy(ay);aM.copy(aY.multiplyScalar(aM.subVectors(a0,a5).dot(a2)*av));aY.copy(aw);aM.add(aY.multiplyScalar(aX.subVectors(a0,a1).dot(a2)*av));ay.normalize();aw.normalize();aE=ay.dot(aw);if(aE<-1){aE=-1}if(aE>1){aE=1}a8=Math.acos(aE);a3=Y.invmass*aT.lengthSq()+X.invmass*aQ.lengthSq()+W.invmass*aN.lengthSq()+t.invmass*aM.lengthSq();if(a3===0){continue}a3=(a8-c.bendRest)/a3*c.bendStiff;if(ay.cross(aw).dot(a2)>0){a3=-a3}a5.add(aT.multiplyScalar(-a3*Y.invmass));a1.add(aQ.multiplyScalar(-a3*X.invmass));a0.add(aN.multiplyScalar(-a3*W.invmass));aZ.add(aM.multiplyScalar(-a3*t.invmass))}}}return this.estimateNewVelocity(aK)};h.prototype.applyBallContact=function(aa,Z){var t,W,X,Y;this.diff.subVectors(aa.position,Z.position);Y=this.diff.length();if(Y>Z.radius){return}t=this.diff.multiplyScalar(1-Z.radius/Y);W=t.multiplyScalar(this.particleMass/(Z.mass+this.particleMass));Z.position.add(W);X=t.multiplyScalar(Z.mass/this.particleMass);return aa.position.sub(X)};h.prototype.applyConstrains=function(Z,aa,ab,Y){var t,W,X;this.diff.subVectors(Z.position,aa.position);X=this.diff.length();if(X===0){return}t=this.diff.multiplyScalar(1-ab/X);W=t.multiplyScalar(0.5).multiplyScalar(1-Math.pow(1-i,1/(Y+1)));aa.position.add(W);return Z.position.sub(W)};h.prototype.estimateNewVelocity=function(X){var W,t,aa,Z,Y;Z=this.particles;Y=[];for(W=0,t=Z.length;W<t;W++){aa=Z[W];Y.push(aa.velocity.subVectors(aa.position,aa.previous).multiplyScalar(1/X))}return Y};h.prototype.plane=function(Y,W,Z){var X,t;t=W*Y;X=Z*Y;return function(ab,aa){var ad,ac;ad=c.lerp(-t/2,t/2,ab);ac=c.lerp(X/2,3*X/2,aa);return new THREE.Vector3(ad,ac,0)}};h.prototype.index=function(W,t){return W+t*(this.ws+1)};h.prototype.setFaces=function(X){var af,ac,aj,ag,ad,aa,Y,W,t,ak,ai,ae,ab,Z,ah;this.faces=X;for(ag=ad=0,ak=this.hs-1;0<=ak?ad<=ak:ad>=ak;ag=0<=ak?++ad:--ad){for(aj=aa=0,ai=this.ws-1;0<=ai?aa<=ai:aa>=ai;aj=0<=ai?++aa:--aa){af=this.faces[aj*2+ag*this.ws*2];ac=this.faces[aj*2+1+ag*this.ws*2];this.bendConstrains.push([af,ac,this.particles[af.a],this.particles[ac.b],this.particles[af.b],this.particles[af.c]])}}for(ag=Y=0,ae=this.hs-1;0<=ae?Y<=ae:Y>=ae;ag=0<=ae?++Y:--Y){for(aj=W=0,ab=this.ws-2;0<=ab?W<=ab:W>=ab;aj=0<=ab?++W:--W){af=this.faces[aj*2+1+ag*this.ws*2];ac=this.faces[aj*2+2+ag*this.ws*2];this.bendConstrains.push([af,ac,this.particles[af.c],this.particles[ac.b],this.particles[af.a],this.particles[af.b]])}}ah=[];for(aj=t=0,Z=this.ws-1;0<=Z?t<=Z:t>=Z;aj=0<=Z?++t:--t){ah.push((function(){var an,am,al;al=[];for(ag=an=0,am=this.hs-2;0<=am?an<=am:an>=am;ag=0<=am?++an:--an){af=this.faces[aj*2+1+ag*this.ws*2];ac=this.faces[aj*2+(ag+1)*this.ws*2];al.push(this.bendConstrains.push([af,ac,this.particles[af.a],this.particles[ac.c],this.particles[ac.a],this.particles[ac.b]]))}return al}).call(this))}return ah};return h})();f=function(){u.aspect=window.innerWidth/window.innerHeight;u.updateProjectionMatrix();return D.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",f,false);e=function(){var h;h=new Stats();h.setMode(0);h.domElement.style.position="absolute";h.domElement.style.left="0px";h.domElement.style.top="0px";return h};H=function(){var h,t,W;W=new THREE.Scene();h=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);h.position.x=-300;h.position.y=400;h.position.z=300;h.position.multiplyScalar(0.6);h.lookAt(new THREE.Vector3(50,0,50));t=new THREE.WebGLRenderer({antialias:true});t.setClearColor(15658734);t.setSize(window.innerWidth,window.innerHeight);t.shadowMap.enabled=true;return{scene:W,camera:h,renderer:t}};Q=e();document.getElementById("stats-output").appendChild(Q.domElement);k=H(),A=k.scene,u=k.camera,D=k.renderer;document.body.appendChild(D.domElement);A.add(new THREE.AmbientLight(6710886));x=new THREE.DirectionalLight(14674943,0.8);x.position.set(50,200,100);x.castShadow=true;x.shadow.camera.near=2;x.shadow.camera.far=1000;x.shadow.camera.left=-500;x.shadow.camera.right=500;x.shadow.camera.top=500;x.shadow.camera.bottom=-500;x.shadow.mapSize.width=1024;x.shadow.mapSize.height=1024;A.add(x);w=new G(3,40,40);
    O=new THREE.MeshLambertMaterial({color:2274815,side:THREE.DoubleSide});N=new THREE.MeshBasicMaterial({color:2274815,wireframe:true});j=new THREE.ParametricGeometry(w.planeFunc,w.ws,w.hs);w.setFaces(j.faces);b=THREE.SceneUtils.createMultiMaterialObject(j,[O,N]);b.position.set(0,0,0);b.children[0].receiveShadow=true;A.add(b);g=function(t,h){var Z,X,W,Y;W=new THREE.Vector3();W.subVectors(t.position,h.position);Y=W.length();X=t.radius+h.radius;if(Y>X){return}W.multiplyScalar(1-X/Y);Z=W.multiplyScalar(0.5);t.position.sub(Z);return h.position.add(Z)};v=[];d=[];(c.tossBalls=function(){var h,ad,ab,aa,Z,W,t,X,Y,ac;A.remove.apply(A,v);d=[];v=[];W=10;ab=15;aa=new THREE.MeshLambertMaterial({color:9132544});h=5;for(ac=X=0,Y=h-1;0<=Y?X<=Y:X>=Y;ac=0<=Y?++X:--X){t=new THREE.Vector3(-25+ac*15,200,55+ac*15);d.push(new z(t,W,ab));ad=new THREE.SphereGeometry(W,32,32);Z=new THREE.Mesh(ad,aa);Z.position.copy(t);Z.castShadow=true;Z.receiveShadow=true;v.push(Z)}A.add.apply(A,v);return w.collisionProxy=d})();M=new dat.GUI();M.add(c,"wireframe").onChange().listen();R=M.addFolder("Wind Force");R.add(I.windForce,"x",-10,20);R.add(I.windForce,"y",-10,20);R.add(I.windForce,"z",-10,20);R.open();R=M.addFolder("Cloth Coefficient");R.add(c,"bendRest",0,Math.PI*0.1);R.add(c,"bendStiff",0,0.3);M.add(c,"tossBalls");J=new THREE.AxisHelper(20);A.add(J);a=function(){return c.wireframe=false};setTimeout(a,4000);C=function(){var h,ad,aa,Y,W,af,ab,t,ae,ac,Z,X;w.simulate(B);ac=w.particles;for(ad=Y=0,af=ac.length;Y<af;ad=++Y){ae=ac[ad];j.vertices[ad].copy(ae.position)}j.computeFaceNormals();j.computeVertexNormals();j.normalsNeedUpdate=true;j.verticesNeedUpdate=true;N.wireframe=c.wireframe;for(ad=W=0,ab=d.length;W<ab;ad=++W){h=d[ad];h.simulate(B);v[ad].position.copy(h.position);for(aa=t=Z=ad,X=d.length-1;Z<=X?t<=X:t>=X;aa=Z<=X?++t:--t){if(aa===ad){continue}g(d[ad],d[aa]);v[ad].position.copy(d[ad].position);v[aa].position.copy(d[aa].position)}}Q.update();requestAnimationFrame(C);return D.render(A,u)};C()}).call(this);