//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 5/27/2016  All rights reserved by @NeZha

(function(){var g,N,s,v,D,l,n,G,M,H,a,z,F,A,L,B,c,K,m,q,d,I,o,y,e,w,i,E,k,t,x,r,b,u,J,f,C;z=new THREE.Vector3(0,-9.8,0);s=18/1000;v=s*s;y=[0,40];C=new THREE.Vector3(0,5,15);g=(function(){h.prototype.damping=0.03;h.prototype.drag=1-0.03;h.prototype.mass=0.1;h.prototype.w=0;h.prototype.h=0;h.prototype.particles=void 0;h.prototype.constrains=void 0;h.prototype.clothFunc=void 0;h.prototype.diff=void 0;function h(p,ae,T,V){var ad,ac,ab,aa,Z,Y,O,X,W,S,Q,P,U,R;ae=ae||10;T=T||10;this.w=ae;this.h=T;this.particles=[];this.constrains=[];this.diff=new THREE.Vector3();this.clothFunc=this.plane(p*ae,p*T);for(R=ad=0,O=T;0<=O?ad<=O:ad>=O;R=0<=O?++ad:--ad){for(U=ac=0,X=ae;0<=X?ac<=X:ac>=X;U=0<=X?++ac:--ac){this.particles.push(new N(this.clothFunc(U/ae,R/T),this.mass))}}for(R=ab=0,W=T-1;0<=W?ab<=W:ab>=W;R=0<=W?++ab:--ab){for(U=aa=0,S=ae-1;0<=S?aa<=S:aa>=S;U=0<=S?++aa:--aa){this.constrains.push([this.particles[this.index(U,R)],this.particles[this.index(U,R+1)],p]);this.constrains.push([this.particles[this.index(U,R)],this.particles[this.index(U+1,R)],p])}}U=ae;for(R=Z=0,Q=T-1;0<=Q?Z<=Q:Z>=Q;R=0<=Q?++Z:--Z){this.constrains.push([this.particles[this.index(U,R)],this.particles[this.index(U,R+1)],p])}R=T;for(U=Y=0,P=ae-1;0<=P?Y<=P:Y>=P;U=0<=P?++Y:--Y){this.constrains.push([this.particles[this.index(U,R)],this.particles[this.index(U+1,R)],p])}}h.prototype.index=function(p,j){return p+j*(this.w+1)};h.prototype.plane=function(j,p){return function(Q,P){var O,S,R;O=(Q-0.5)*j;S=(P+0.5)*p;R=0;return new THREE.Vector3(O,S,R)}};h.prototype.simulate=function(R,ah,O){var X,p,T,ag,ac,aa,Z,Y,af,ad,S,W,ai,ab,ae,Q,V,U,P;if(typeof af!=="undefined"&&af!==null){af=R;return}ae=this.particles;U=new THREE.Vector3();if(C!=null){for(aa=0,ad=ah.length;aa<ad;aa++){T=ah[aa];ai=T.normal;U.copy(ai).normalize().multiplyScalar(ai.dot(O));ae[T.a].addForce(U);ae[T.b].addForce(U);ae[T.c].addForce(U)}}ag=new THREE.Vector3();for(Z=0,S=ae.length;Z<S;Z++){ab=ae[Z];ag.copy(z).multiplyScalar(this.mass);ab.addForce(ag);ab.integrate(v,this.drag)}V=[];for(ac=Y=0;Y<1;ac=++Y){p=this.constrains;for(ac=W=0,Q=p.length-1;0<=Q?W<=Q:W>=Q;ac=0<=Q?++W:--W){X=p[ac];this.satisfyConstrains(X[0],X[1],X[2])}V.push((function(){var ak,j,aj;aj=[];for(ac=ak=0,j=y.length-1;0<=j?ak<=j:ak>=j;ac=0<=j?++ak:--ak){P=y[ac];ab=ae[P];ab.position.copy(ab.original);aj.push(ab.previous.copy(ab.original))}return aj})())}return V};h.prototype.satisfyConstrains=function(Q,P,R){var j,p,O;this.diff.subVectors(P.position,Q.position);O=this.diff.length();if(O===0){return}j=this.diff.multiplyScalar(1-R/O);p=j.multiplyScalar(0.5);Q.position.add(p);return P.position.sub(p)};return h})();N=(function(){h.prototype.position=void 0;h.prototype.previous=void 0;h.prototype.original=void 0;h.prototype.a=void 0;h.prototype.mass=0;h.prototype.invmass=0;h.prototype.tmp=void 0;h.prototype.tmp2=void 0;function h(j,p){this.position=new THREE.Vector3().copy(j);this.previous=new THREE.Vector3().copy(j);this.original=new THREE.Vector3().copy(j);this.a=new THREE.Vector3(0,0,0);this.mass=p;this.invmass=p===0?p:1/p;this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3()}h.prototype.addForce=function(j){this.tmp2.copy(j).multiplyScalar(this.invmass);return this.a.add(this.tmp2)};h.prototype.integrate=function(j,O){var p;p=this.tmp.subVectors(this.position,this.previous);p.multiplyScalar(O).add(this.position);p.add(this.a.multiplyScalar(j));this.tmp=this.previous;this.previous=this.position;this.position=p;return this.a.set(0,0,0)};return h})();d=function(){l.aspect=window.innerWidth/window.innerHeight;l.updateProjectionMatrix();return x.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",d,false);c=function(){var h;h=new Stats();h.setMode(0);return h};B=function(){var h,j,p;p=new THREE.Scene();h=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1100);h.position.x=-300;h.position.y=400;h.position.z=300;h.lookAt(p.position);j=new THREE.WebGLRenderer({antialias:true});j.setPixelRatio(window.devicePixelRatio);j.setClearColor(15658734);j.setSize(window.innerWidth,window.innerHeight);j.shadowMap.enabled=true;return{scene:p,camera:h,renderer:j}};J=c();if((E=document.getElementById("stats-output"))!=null){E.appendChild(J.domElement)}k=B(),r=k.scene,l=k.camera,x=k.renderer;document.body.appendChild(x.domElement);q=new THREE.DirectionalLight(16777215,1);q.position.set(50,200,-100);q.castShadow=true;q.shadow.camera.near=2;q.shadow.camera.far=1000;q.shadow.camera.left=-500;q.shadow.camera.right=500;q.shadow.camera.top=500;q.shadow.camera.bottom=-500;q.shadow.mapSize.width=1024;q.shadow.mapSize.height=1024;r.add(q);f=new THREE.TextureLoader();n=new g(3,40,40);H=new THREE.MeshLambertMaterial({color:2274815,side:THREE.DoubleSide});G=new THREE.MeshBasicMaterial({color:16711680,wireframe:true});M=new THREE.ParametricGeometry(n.clothFunc,n.w,n.h);a=THREE.SceneUtils.createMultiMaterialObject(M,[H,G]);a.position.set(0,0,0);a.children[0].castShadow=true;r.add(a);e=new THREE.PlaneGeometry(1000,1000);w=new THREE.MeshStandardMaterial({roughness:0,metalness:0,color:9132544});
    f.load("../textures/hardwood2_diffuse.jpg",function(h){h.wrapS=THREE.RepeatWrapping;h.wrapT=THREE.RepeatWrapping;h.anisotropy=4;h.repeat.set(3,3);w.map=h;return w.needsUpdate=true});f.load("../textures/hardwood2_bump.jpg",function(h){h.wrapS=THREE.RepeatWrapping;h.wrapT=THREE.RepeatWrapping;h.anisotropy=4;h.repeat.set(3,3);w.bumpMap=h;return w.needsUpdate=true});f.load("../textures/hardwood2_roughness.jpg",function(h){h.wrapS=THREE.RepeatWrapping;h.wrapT=THREE.RepeatWrapping;h.anisotropy=4;h.repeat.set(3,3);w.roughnessMap=h;return w.needsUpdate=true});f=void 0;i=new THREE.Mesh(e,w);i.position.set(0,-5,0);i.rotation.x=-Math.PI/2;i.receiveShadow=true;r.add(i);b=new THREE.SphereGeometry(5);u=new THREE.MeshNormalMaterial();for(K=0,m=y.length;K<m;K++){I=y[K];o=new THREE.Mesh(b,u);o.position.copy(n.particles[I].position);r.add(o)}D=new THREE.AxisHelper(20);r.add(D);A={wireframe:true,useshadow:true,lightColor:"#ffffff"};F=new dat.GUI();F.add(A,"wireframe").listen();F.add(A,"useshadow").listen();F.addColor(A,"lightColor");L=F.addFolder("wind force");L.add(C,"x",-10,15);L.add(C,"y",-10,15);L.add(C,"z",-10,15);setTimeout(function(){return A.wireframe=false},4000);t=function(){var p,j,h,O;J.update();O=Date.now();G.visible=A.wireframe;q.castShadow=A.useshadow;q.color.setStyle(A.lightColor);n.simulate(O,M.faces,C);I=n.particles;for(p=j=0,h=I.length-1;0<=h?j<=h:j>=h;p=0<=h?++j:--j){M.vertices[p].copy(I[p].position)}M.computeFaceNormals();M.computeVertexNormals();M.normalsNeedUpdate=true;M.verticesNeedUpdate=true;requestAnimationFrame(t);return x.render(r,l)};document.getElementById("loading").style.display="none";t()}).call(this);