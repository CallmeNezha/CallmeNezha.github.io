//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 5/27/2016  All rights reserved by @NeZha

(function(){var G,q,l,y,j,e,L,t,B,m,K,o,E,f,F,a,b,x,D,I,n,z,c,i,p,d,k,w,g,J,C,u,v,s,r,H,A;i={subVectors:function(M,h){return[M[0]-h[0],M[1]-h[1],M[2]-h[2]]},lengthSq:function(h){return h[0]*h[0]+h[1]*h[1]+h[2]*h[2]},length:function(h){return Math.sqrt(this.lengthSq(h))},divVector:function(M,h){M[0]/=h;M[1]/=h;return M[2]/=h},mulVector:function(M,h){M[0]*=h;M[1]*=h;return M[2]*=h},createZeroMatrix:function(R,O){var S,M,h,Q,P,N;h=[];for(Q=M=0,P=R;0<=P?M<P:M>P;Q=0<=P?++M:--M){h.push(N=(function(){var U,T,V;V=[];for(S=U=0,T=O;0<=T?U<T:U>T;S=0<=T?++U:--U){V.push(0)}return V})())}return h},createIndentityMatrix:function(P){var M,h,O,N;h=this.createZeroMatrix(P,P);for(O=M=0,N=P;0<=N?M<N:M>N;O=0<=N?++M:--M){h[O][O]=1}return h},diagonalMultiply:function(M,h){var N,Q,P,O;O=[];for(Q=N=0,P=M.length;0<=P?N<P:N>P;Q=0<=P?++N:--N){O.push(M[Q][Q]*=h)}return O},getColumn:function(h,Q){var M,P,O,N;N=[];for(P=M=0,O=h.length;0<=O?M<O:M>O;P=0<=O?++M:--M){N.push(h[P][Q])}return N}};n=(18/1000)*(18/1000);L=(function(){function h(M){this.points=M;this.projections=void 0;this.constrains=[];this.ASMtRowId=0;this.ASMt_t=[];this.N=void 0;this.ASSparse=void 0;this.ASSparse_t=void 0;this.elements=[];this.M=void 0;this.LUP=void 0}h.prototype.addConstrain=function(M){return this.constrains.push(M)};h.prototype.initialize=function(){var T,S,Q,O,P,N,R,M;R=this.constrains;for(Q=0,P=R.length;Q<P;Q++){T=R[Q];this.ASMtRowId=T.addConstrainMt(this.elements,this.ASMtRowId)}this.ASMt_t=i.createZeroMatrix(this.ASMtRowId,this.points.length);this.projections=i.createZeroMatrix(this.ASMtRowId,3);M=this.elements;for(O=0,N=M.length;O<N;O++){S=M[O];this.ASMt_t[S[0]][S[1]]+=S[2]}this.ASSparse=numeric.ccsSparse(this.ASMt_t);this.ASMt_t=numeric.transpose(this.ASMt_t);this.ASSparse_t=numeric.ccsSparse(this.ASMt_t);this.N=numeric.ccsDot(this.ASSparse_t,this.ASSparse);this.M=i.createIndentityMatrix(this.points.length);i.diagonalMultiply(this.M,1/n);this.N=numeric.ccsadd(numeric.ccsSparse(this.M),this.N);return this.LUP=numeric.ccsLUP(this.N)};h.prototype.solve=function(){var M,Y,U,R,Q,S,P,N,X,O,T,W,V,Z;O=this.constrains;for(R=0,S=O.length;R<S;R++){Y=O[R];Y.project(this.points,this.projections)}V=numeric.dotMMbig(this.ASMt_t,this.projections);P=numeric.dotMMbig(this.M,this.points);W=numeric.add(P,V);T=[];for(Y=Q=0;Q<3;Y=++Q){Z=i.getColumn(W,Y);X=numeric.ccsLUPSolve(this.LUP,Z);M=(function(){switch(Y){case 0:return"x";case 1:return"y";case 2:return"z"}})();T.push((function(){var ab,aa,ac;ac=[];for(U=aa=0,ab=X.length;aa<ab;U=++aa){N=X[U];ac.push(this.points[U][Y]=N)}return ac}).call(this))}return T};return h})();l=(function(){function h(N,S,Q,P,R,O){var M;if(R==null){R=1}if(O==null){O=1}this.pid1=S;this.pid2=Q;this.rMin=R;this.rMax=O;M=i.length(i.subVectors(N[Q],N[S]));this.invRest=M===0?0:1/M;this.weight=P*Math.sqrt(M);this.cid=-1}h.prototype.addConstrainMt=function(M,N){this.cid=N;M.push([N,this.pid1,-this.weight*this.invRest]);M.push([N,this.pid2,this.weight*this.invRest]);return ++N};h.prototype.project=function(N,P){var O,M;O=i.subVectors(N[this.pid2],N[this.pid1]);M=i.length(O);i.divVector(O,M);M=THREE.Math.clamp(M*this.invRest,this.rMin,this.rMax);i.mulVector(O,M*this.weight);return P[this.cid]=O};return h})();g=[];J=[];r=new L(g);b={lerp:function(M,N,h){if((1>=h&&h>=0)){return(N-M)*h+M}if(h<0){return M}if(h>1){return N}},swap:function(M,h){var N;N=M;M=h;return h=N},bendStiff:0.1,bendRest:0.33,wireframe:true};G=0.03;q=1-0.03;A={windForce:new THREE.Vector3(5,2.2,10.5)};t=18/1000;e=90;x=new THREE.Vector3(0,-98,0);w=[{index:[0,0]},{index:[30,0]}];j=(function(){function h(M,P,O,N){this.previous=new THREE.Vector3(M,P,O);this.position=new THREE.Vector3(M,P,O);this.original=new THREE.Vector3(M,P,O);this.velocity=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3();this.mass=N!=null?N:0;this.invmass=this.mass===0?0:1/this.mass;this.a=new THREE.Vector3(0,0,0)}h.prototype.addForce=function(M){this.tmp.copy(M).multiplyScalar(this.invmass);return this.a.add(this.tmp)};h.prototype.integrate=function(M,N){var O;O=this.tmp2;this.velocity.add(this.a.multiplyScalar(M));O.copy(this.velocity).multiplyScalar(N*M).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=O;return this.a.set(0,0,0)};return h})();y=(function(){h.prototype.particleMass=0.1;h.prototype.lastTime=void 0;function h(M,af,V){var ag,P,O,ae,ad,ac,ab,Z,Y,N,X,W,T,R,Q,U,S;this.faces=void 0;this.ws=af;this.hs=V;this.particles=[];this.planeFunc=this.plane(M,af,V);this.collisionProxy=void 0;this.constrains=[];this.diff=new THREE.Vector3();this.bendConstrains=[];for(S=ae=0,N=V;0<=N?ae<=N:ae>=N;S=0<=N?++ae:--ae){for(U=ad=0,X=af;0<=X?ad<=X:ad>=X;U=0<=X?++ad:--ad){Y=this.planeFunc(U/af,S/V);this.particles.push(new j(Y.x,Y.y,Y.z,this.particleMass));g.push([Y.x,Y.y,Y.z])}}for(S=ac=0,W=V;0<=W?ac<W:ac>W;S=0<=W?++ac:--ac){for(U=ab=0,T=af;0<=T?ab<T:ab>T;U=0<=T?++ab:--ab){P=this.index(U,S);O=this.index(U,S+1);r.addConstrain(new l(g,P,O,e));P=this.index(U,S);O=this.index(U+1,S);
    r.addConstrain(new l(g,P,O,e))}}U=af;for(S=Z=0,R=V;0<=R?Z<R:Z>R;S=0<=R?++Z:--Z){P=this.index(U,S);O=this.index(U,S+1);r.addConstrain(new l(g,P,O,e))}S=V;for(U=ag=0,Q=af;0<=Q?ag<Q:ag>Q;U=0<=Q?++ag:--ag){P=this.index(U,S);O=this.index(U+1,S);r.addConstrain(new l(g,P,O,e))}r.initialize()}h.prototype.estimateNewVelocity=function(M){var O,N,R,Q,P;Q=this.particles;P=[];for(O=0,N=Q.length;O<N;O++){R=Q[O];P.push(R.velocity.subVectors(R.position,R.previous).multiplyScalar(1/M))}return P};h.prototype.plane=function(P,N,Q){var O,M;M=N*P;O=Q*P;return function(S,R){var U,T;U=b.lerp(-M/2,M/2,S);T=b.lerp(O/2,3*O/2,R);return new THREE.Vector3(U,T,0)}};h.prototype.index=function(N,M){return N+M*(this.ws+1)};h.prototype.setFaces=function(M){return this.faces=M};h.prototype.simulate=function(M){var al,U,ak,aj,ah,ag,T,R,Q,P,O,af,ae,am,ad,ai,S,N,ac,ab,Z,X,Y,W,V;Y=new THREE.Vector3();if(this.faces==null){console.warn("clothFaces not assigned!")}if((A!=null)&&(this.faces!=null)){N=this.faces;for(ah=0,T=N.length;ah<T;ah++){U=N[ah];am=U.normal;Y.copy(am).normalize().multiplyScalar(am.dot(A.windForce));this.particles[U.a].addForce(Y);this.particles[U.b].addForce(Y);this.particles[U.c].addForce(Y)}}ak=new THREE.Vector3().copy(x);ak.multiplyScalar(this.particleMass);ac=this.particles;for(ag=0,R=ac.length;ag<R;ag++){ai=ac[ag];ai.addForce(ak);ai.integrate(M,q)}for(af=0,Q=w.length;af<Q;af++){S=w[af];if(S.index==null){continue}ab=S.index,W=ab[0],V=ab[1];ai=this.particles[this.index(W,V)];if(S.position!=null){ai.position.set(S.position[0],S.position[1],S.position[2])}else{ai.position.copy(ai.original);ai.previous.copy(ai.original)}}Z=this.particles;for(aj=ae=0,P=Z.length;ae<P;aj=++ae){ai=Z[aj];g[aj][0]=ai.position.x;g[aj][1]=ai.position.y;g[aj][2]=ai.position.z}for(aj=ad=0;ad<1;aj=++ad){r.solve()}X=this.particles;for(aj=al=0,O=X.length;al<O;aj=++al){ai=X[aj];ai.position.x=g[aj][0];ai.position.y=g[aj][1];ai.position.z=g[aj][2]}return this.estimateNewVelocity(M)};return h})();d=function(){m.aspect=window.innerWidth/window.innerHeight;m.updateProjectionMatrix();return v.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",d,false);k=void 0;c=function(){var h;h=new Stats();h.setMode(0);h.domElement.style.position="absolute";h.domElement.style.left="0px";h.domElement.style.top="0px";return h};z=function(){var h,M,N;N=new THREE.Scene();h=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);h.position.x=-100;h.position.y=400;h.position.z=300;h.lookAt(new THREE.Vector3(300,0,300));M=new THREE.WebGLRenderer({antialias:true});M.setPixelRatio(window.devicePixelRatio);M.setClearColor(15658734);M.setSize(window.innerWidth,window.innerHeight);M.shadowMap.enabled=false;k=new THREE.OrbitControls(h);k.center.set(0,0,150);k.autoRotate=false;return{scene:N,camera:h,renderer:M}};H=c();document.getElementById("stats-output").appendChild(H.domElement);C=z(),s=C.scene,m=C.camera,v=C.renderer;document.body.appendChild(v.domElement);s.add(new THREE.AmbientLight(6710886,1));p=new THREE.DirectionalLight(14674943,1);p.position.set(50,200,-100);p.castShadow=false;p.shadow.camera.near=2;p.shadow.camera.far=1000;p.shadow.camera.left=-500;p.shadow.camera.right=500;p.shadow.camera.top=500;p.shadow.camera.bottom=-500;p.shadow.mapSize.width=1024;p.shadow.mapSize.height=1024;s.add(p);B=new THREE.AxisHelper(20);B.position.set(0,0,150);s.add(B);o=new y(5,30,30);F=new THREE.MeshLambertMaterial({color:2274815,side:THREE.DoubleSide});E=new THREE.MeshBasicMaterial({color:16711680,wireframe:true});f=new THREE.ParametricGeometry(o.planeFunc,o.ws,o.hs);o.setFaces(f.faces);a=THREE.SceneUtils.createMultiMaterialObject(f,[F,E]);a.position.set(0,0,0);s.add(a);D=new dat.GUI();D.add(b,"wireframe").onChange();I=D.addFolder("Wind Force");I.add(A.windForce,"x",-10,20);I.add(A.windForce,"y",-10,20);I.add(A.windForce,"z",-10,20);K=new THREE.Clock();u=function(){var Q,O,N,M,P,h;Q=K.getDelta();k.update(Q);o.simulate(t);h=o.particles;for(O=N=0,M=h.length;N<M;O=++N){P=h[O];f.vertices[O].copy(P.position)}f.computeFaceNormals();f.computeVertexNormals();f.normalsNeedUpdate=true;f.verticesNeedUpdate=true;E.wireframe=b.wireframe;H.update();requestAnimationFrame(u);return v.render(s,m)};document.getElementById("loading").style.display="none";u()}).call(this);