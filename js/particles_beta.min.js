//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 6/5/2016  All rights reserved by @NeZha

(function(){var F,q,V,K,J,v,C,d,S,B,U,r,M,E,h,T,R,Q,z,s,e,f,k,b,O,P,D,m,a,I,p,L,t,N,y,j,A,G,H,u,g,w,c,o,x,n;x="precision mediump float;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n    uniform float scale;\n\nattribute vec3 position;\nattribute vec2 uv;\nattribute vec3 translate;\n    attribute float  particleIndex;\n\nvarying vec2 vUv;\n    varying vec3 vColor;\n\n\nvoid main() {\n\n	vec4 mvPosition = modelViewMatrix * vec4( translate, 1.0 );\n	mvPosition.xyz += position * scale;\n	vUv = uv;\n      vColor = vec3( cos(particleIndex*0.3)+1.0, sin(particleIndex*0.6)+1.0, cos(particleIndex*0.9)+1.0)*translate/2.0;\n	gl_Position = projectionMatrix * mvPosition;\n}";B="precision mediump float;\n\nuniform sampler2D map;\n\n    varying vec3 vColor;\nvarying vec2 vUv;\n\n// HSL to RGB Convertion helpers\nvec3 HUEtoRGB(float H){\n	H = mod(H,1.0);\n	float R = abs(H * 6.0 - 3.0) - 1.0;\n	float G = 2.0 - abs(H * 6.0 - 2.0);\n	float B = 2.0 - abs(H * 6.0 - 4.0);\n	return clamp(vec3(R,G,B),0.0,1.0);\n}\n\nvec3 HSLtoRGB(vec3 HSL){\n	vec3 RGB = HUEtoRGB(HSL.x);\n	float C = (1.0 - abs(2.0 * HSL.z - 1.0)) * HSL.y;\n	return (RGB - 0.5) * C + HSL.z;\n}\n\nvoid main() {\n	vec4 diffuseColor = texture2D( map, vUv );\n	gl_FragColor = vec4( diffuseColor.xyz * vColor, diffuseColor.w );\n\n	if ( diffuseColor.w < 0.5 ) discard;\n}";r=function(ab,W,ah,ag){var ac,ai,Z,af,ad,aa,Y,X,ae;Z=Math.ceil(Math.pow(ah,1/3));ai=0;ae=[];for(af=Y=0,X=Z;0<=X?Y<X:Y>X;af=0<=X?++Y:--Y){if(ai>=ah){break}ae.push((function(){var i,l,aj;aj=[];for(ad=i=0,l=Z;0<=l?i<l:i>l;ad=0<=l?++i:--i){if(ai>=ah){break}aj.push((function(){var am,ak,al;al=[];for(aa=am=0,ak=Z;0<=ak?am<ak:am>ak;aa=0<=ak?++am:--am){if(ai>=ah){break}ac=ai*3;ag[ac+0]=ab.x+W*aa+Math.random()*W/10;ag[ac+2]=ab.z+W*ad+Math.random()*W/10;ag[ac+1]=ab.y+W*af+Math.random()*W/10;al.push(++ai)}return al})())}return aj})())}return ae};J=function(l,i){return i.set(Math.floor((l.x-b.gridOrigin.x)/b.cellSize),Math.floor((l.y-b.gridOrigin.y)/b.cellSize),Math.floor((l.z-b.gridOrigin.z)/b.cellSize))};K=function(i){i.x=i.x&(b.gridSize-1);i.y=i.y&(b.gridSize-1);i.z=i.z&(b.gridSize-1);return i.z*b.gridSize*b.gridSize+i.y*b.gridSize+i.x};d=function(i){var W,l;l=i*0.5;W=new THREE.Geometry();W.vertices.push(new THREE.Vector3(-l,-l,-l),new THREE.Vector3(-l,l,-l),new THREE.Vector3(-l,l,-l),new THREE.Vector3(l,l,-l),new THREE.Vector3(l,l,-l),new THREE.Vector3(l,-l,-l),new THREE.Vector3(l,-l,-l),new THREE.Vector3(-l,-l,-l),new THREE.Vector3(-l,-l,l),new THREE.Vector3(-l,l,l),new THREE.Vector3(-l,l,l),new THREE.Vector3(l,l,l),new THREE.Vector3(l,l,l),new THREE.Vector3(l,-l,l),new THREE.Vector3(l,-l,l),new THREE.Vector3(-l,-l,l),new THREE.Vector3(-l,-l,-l),new THREE.Vector3(-l,-l,l),new THREE.Vector3(-l,l,-l),new THREE.Vector3(-l,l,l),new THREE.Vector3(l,l,-l),new THREE.Vector3(l,l,l),new THREE.Vector3(l,-l,-l),new THREE.Vector3(l,-l,l));return W};F=(function(){var W,X,l,Y;W=new THREE.Clock();function i(){var aa,Z;this.onSimulate=void 0;this.onRender=void 0;this.bPause=false;this.terminate=false;this.stats=l();aa=X(),this.scene=aa.scene,this.camera=aa.camera,this.renderer=aa.renderer;this.garage={};Z=Y.bind(this);window.addEventListener("resize",Z,false)}i.prototype.setOnSimulate=function(Z){return this.onSimulate=Z};i.prototype.setOnRender=function(Z){return this.onRender=Z};i.prototype.resume=function(){return this.bPause=false};i.prototype.pause=function(){return this.bPause=true};i.prototype.selfDestruct=function(){var Z;for(Z in this){this[Z]=void 0}};i.prototype.begin=function(){var Z;Z=function(){var aa;if(this.terminate===true){return}requestAnimationFrame(Z);aa=W.getElapsedTime();if(this.bPause===false){if(typeof this.onSimulate==="function"){this.onSimulate(aa)}}if(typeof this.onRender==="function"){this.onRender(aa)}this.renderer.render(this.scene,this.camera);return this.stats.update()};Z=Z.bind(this);return Z()};i.prototype.terminate=function(){return this.terminate=true};l=function(){var Z;Z=new Stats();Z.setMode(0);return Z};X=function(){var Z,aa,ab;ab=new THREE.Scene();Z=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,5001);Z.position.x=300;Z.position.y=180;Z.position.z=300;Z.position.multiplyScalar(1);Z.lookAt(ab.position);aa=new THREE.WebGLRenderer({antialias:true});aa.setPixelRatio(window.devicePixelRatio);aa.setClearColor(0);aa.setSize(window.innerWidth,window.innerHeight);aa.shadowMap.enabled=false;return{scene:ab,camera:Z,renderer:aa}};Y=function(){this.camera.aspect=window.innerWidth/window.innerHeight;this.camera.updateProjectionMatrix();return this.renderer.setSize(window.innerWidth,window.innerHeight)};return i})();a=new F();if(a.renderer.extensions.get("ANGLE_instanced_arrays")===false){document.getElementById("notSupported").style.display="";return}document.getElementById("stats-output").appendChild(a.stats.domElement);document.getElementById("webgl-output").appendChild(a.renderer.domElement);k=new THREE.OrbitControls(a.camera,a.renderer.domElement);k.maxDistance=1000;
  k.minDistance=300;k.center.copy(a.scene.position);U=d(205);U.computeLineDistances();a.scene.add(new THREE.LineSegments(U,new THREE.LineDashedMaterial({color:16755200,dashSize:3,gapSize:1,linewidth:2})));b={numParticles:4000,showRadius:3,radius:0.03,cellSize:0.06,invcellSize:1/0.06,gridSize:64,gridOrigin:new THREE.Vector3(-0.5,-0.5,-0.5),stepTime:1/30,pause:false,globalDamping:1,boundaryDamping:-1,ppDamping:0.02,ppSpring:0.8,ppShear:0,ppAttraction:0,gravity:[0,-0.098*0.4,0],wall:0.5};L=(function(){var ab,ae,ac,aa,ad,Z,X,Y,W;Z=new THREE.InstancedBufferGeometry();Z.copy(new THREE.CircleBufferGeometry(b.showRadius,6));W=new Float32Array(b.numParticles*3);ae=new Float32Array(b.numParticles);for(ab=aa=0,Y=b.numParticles;0<=Y?aa<Y:aa>Y;ab=0<=Y?++aa:--aa){W[ab*3+0]=Math.random()-0.5;W[ab*3+1]=Math.random()-0.5;W[ab*3+2]=Math.random()-0.5;ae[ab]=ab}ad=new THREE.InstancedBufferAttribute(W,3,1).setDynamic(true);Z.addAttribute("translate",ad);ac=new THREE.InstancedBufferAttribute(ae,1,1);Z.addAttribute("particleIndex",ac);X=new THREE.RawShaderMaterial({uniforms:{map:{type:"t",value:new THREE.TextureLoader().load("../textures/sprites/ball.png")},scale:{type:"f",value:1}},vertexShader:x,fragmentShader:B,depthTest:true,depthWrite:true});return[new THREE.Mesh(Z,X),ad]})(),P=L[0],m=L[1];P.scale.set(100,100,100);a.scene.add(P);n=new THREE.Mesh(new THREE.PlaneGeometry(110,110),new THREE.MeshBasicMaterial({color:11184810,side:THREE.DoubleSide}));n.position.set(0,0,-150);a.scene.add(n);O=new Array(b.numParticles);D=m.array;o=new Float32Array(b.numParticles*3);h=new Array(b.numParticles);E=new Array(b.numParticles);for(T=R=0,t=b.numParticles*3;0<=t?R<t:R>t;T=0<=t?++R:--R){o[T]=0}f=function(al){var ax,Z,Y,W,l,at,X,ay,ab,av,au,ar,aq,ap,aw,az,an,ai,ag,af,i,aa,aj,ah,ao,am,ak,ae,ad,ac;aa=performance.now();b.gravity[0]=Math.sin(al*0.2)*Math.sin(al*0.5)*0.025;for(T=av=0,ai=b.numParticles;0<=ai?av<ai:av>ai;T=0<=ai?++av:--av){at=T*3;ae=at;ad=at+1;ac=at+2;o[ae]+=b.gravity[0]*b.stepTime;o[ad]+=b.gravity[1]*b.stepTime;o[ac]+=b.gravity[2]*b.stepTime;o[ae]*=b.globalDamping;o[ad]*=b.globalDamping;o[ac]*=b.globalDamping;D[ae]+=o[ae]*b.stepTime;D[ad]+=o[ad]*b.stepTime;D[ac]+=o[ac]*b.stepTime;if((-0.7>(ag=D[ae])&&ag>-0.9)){o[ad]+=0.098}if(D[ae]>1){D[ae]=1;o[ae]*=b.boundaryDamping}if(D[ae]<-1){D[ae]=-1;o[ae]*=b.boundaryDamping}if(D[ad]>1){D[ad]=1;o[ad]*=b.boundaryDamping}if(D[ad]<-1){D[ad]=-1;o[ad]*=b.boundaryDamping}if(D[ac]>1){D[ac]=1;o[ac]*=b.boundaryDamping}if(D[ac]<-1){D[ac]=-1;o[ac]*=b.boundaryDamping}}ax=[0,0,0];for(T=au=0,af=b.numParticles;0<=af?au<af:au>af;T=0<=af?++au:--au){at=T*3;ax[0]=Math.floor((D[at+0]-b.gridOrigin.x)*b.invcellSize);ax[1]=Math.floor((D[at+1]-b.gridOrigin.y)*b.invcellSize);ax[2]=Math.floor((D[at+2]-b.gridOrigin.z)*b.invcellSize);ax[0]=ax[0]&(b.gridSize-1);ax[1]=ax[1]&(b.gridSize-1);ax[2]=ax[2]&(b.gridSize-1);l=ax[2]*b.gridSize*b.gridSize+ax[1]*b.gridSize+ax[0];O[T]={index:T,hash:l}}i=function(aA){var aB;aB=aA;return function(aD,aC){return aD[aB]-aC[aB]}};O.sort(i("hash"));X=O[0].hash;h[X]=0;for(T=aq=0,ay=O.length;aq<ay;T=++aq){az=O[T];if(az.hash===X){continue}E[X]=T;X=az.hash;h[X]=T}E[X]=b.numParticles;ar=[0,0,0];for(ap=0,ab=O.length;ap<ab;ap++){az=O[ap];aw=az.index*3;ae=D[aw];ad=D[aw+1];ac=D[aw+2];ao=o[aw];am=o[aw+1];ak=o[aw+2];ax[0]=Math.floor((ae-b.gridOrigin.x)*b.invcellSize);ax[1]=Math.floor((ad-b.gridOrigin.y)*b.invcellSize);ax[2]=Math.floor((ac-b.gridOrigin.z)*b.invcellSize);ax[0]=ax[0]&(b.gridSize-1);ax[1]=ax[1]&(b.gridSize-1);ax[2]=ax[2]&(b.gridSize-1);A(V);for(W=an=-1;an<=1;W=++an){for(Y=aj=-1;aj<=1;Y=++aj){for(Z=ah=-1;ah<=1;Z=++ah){ar[0]=ax[0]+Z;ar[1]=ax[1]+Y;ar[2]=ax[2]+W;v(aw,ae,ad,ac,ao,am,ak,ar,D,o,h,E,O)}}}o[aw+0]=ao+V[0];o[aw+1]=am+V[1];o[aw+2]=ak+V[2]}return m.needsUpdate=true};z=[0,0,0];N=[0,0,0];y=[0,0,0];w=[0,0,0];c=[0,0,0];I=[0,0,0];V=[0,0,0];Q=function(l,i){l[0]*=i;l[1]*=i;return l[2]*=i};q=function(l,i){l[0]+=i[0];l[1]+=i[1];return l[2]+=i[2]};G=function(l,i){l[0]-=i[0];l[1]-=i[1];return l[2]-=i[2]};u=function(l,i,X,W){v1[0]-=i;v1[1]-=X;return v1[2]-=W};H=function(Y,i,X,W,l){l[0]=Y[0]-i;l[1]=Y[1]-X;return l[2]=Y[2]-W};g=function(W,Y,aa,l,X,Z,i){i[0]=W-l;i[1]=Y-X;return i[2]=aa-Z};j=function(l,i,X,W){l[0]=i;l[1]=X;return l[2]=W};s=function(i){return i[0]*i[0]+i[1]*i[1]+i[2]*i[2]};C=function(l,i){l[0]=i[0];l[1]=i[1];return l[2]=i[2]};S=function(l,i){return l[0]*i[0]+l[1]*i[1]+l[2]*i[2]};A=function(i){i[0]=0;i[1]=0;return i[2]=0};v=function(am,ac,ab,aa,ai,ag,af,W,X,Z,an,Y,ao){var i,ak,l,al,ah,ae,ad,aj;l=W[2]*b.gridSize*b.gridSize+W[1]*b.gridSize+W[0];aj=[];for(T=al=ae=an[l],ad=Y[l];ae<=ad?al<ad:al>ad;T=ae<=ad?++al:--al){ah=ao[T].index*3;if(am===ah){continue}g(X[ah],X[ah+1],X[ah+2],ac,ab,aa,N);ak=Math.sqrt(s(N));i=2*b.radius;if(ak>i){continue}C(z,N);Q(z,1/ak);g(Z[ah],Z[ah+1],Z[ah+2],ai,ag,af,y);C(c,z);C(w,y);Q(c,S(y,z));G(w,c);C(I,z);Q(I,-b.ppSpring*(i-ak));Q(y,b.ppDamping);q(I,y);Q(w,b.ppShear);q(I,w);Q(N,b.ppAttraction);q(I,N);aj.push(q(V,I))}return aj};e=function(){return k.update()};a.renderer.gammaInput=true;
  a.renderer.gammaOutput=true;a.setOnSimulate(f);a.setOnRender(e);a.begin();p=function(i){return P.material.uniforms.scale.value=i};M=new dat.GUI();M.add(b,"pause").listen().onChange(function(i){switch(i){case true:return a.pause();case false:return a.resume()}})}).call(this);