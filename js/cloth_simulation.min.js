/**
 * Created by Nezha on 2016/5/24.
 */
(function(){var b,D,s,d,u,v,x,y,l,k,B,r,g,o,w,n,p,f,e,t,m,j,a,i,C,q,z,A,c;g=new THREE.Vector3(0,-9.8,0);s=18/1000;d=s*s;t=[0,40];c=new THREE.Vector3(0,5,15);r={wireframe:true};b=(function(){h.prototype.damping=0.03;h.prototype.drag=1-0.03;h.prototype.mass=0.1;h.prototype.w=0;h.prototype.h=0;h.prototype.particles=void 0;h.prototype.constrains=void 0;h.prototype.clothFunc=void 0;h.prototype.diff=void 0;function h(E,V,K,M){var U,T,S,R,Q,P,F,O,N,J,H,G,L,I;V=V||10;K=K||10;this.w=V;this.h=K;this.particles=[];this.constrains=[];this.diff=new THREE.Vector3();this.clothFunc=this.plane(E*V,E*K);for(I=U=0,F=K;0<=F?U<=F:U>=F;I=0<=F?++U:--U){for(L=T=0,O=V;0<=O?T<=O:T>=O;L=0<=O?++T:--T){this.particles.push(new D(this.clothFunc(L/V,I/K),this.mass))}}for(I=S=0,N=K-1;0<=N?S<=N:S>=N;I=0<=N?++S:--S){for(L=R=0,J=V-1;0<=J?R<=J:R>=J;L=0<=J?++R:--R){this.constrains.push([this.particles[this.index(L,I)],this.particles[this.index(L,I+1)],E]);this.constrains.push([this.particles[this.index(L,I)],this.particles[this.index(L+1,I)],E])}}L=V;for(I=Q=0,H=K-1;0<=H?Q<=H:Q>=H;I=0<=H?++Q:--Q){this.constrains.push([this.particles[this.index(L,I)],this.particles[this.index(L,I+1)],E])}I=K;for(L=P=0,G=V-1;0<=G?P<=G:P>=G;L=0<=G?++P:--P){this.constrains.push([this.particles[this.index(L,I)],this.particles[this.index(L+1,I)],E])}}h.prototype.index=function(F,E){return F+E*(this.w+1)};h.prototype.plane=function(E,F){return function(I,H){var G,K,J;G=(I-0.5)*E;K=(H+0.5)*F;J=0;return new THREE.Vector3(G,K,J)}};h.prototype.simulate=function(I,Y,F){var O,E,K,X,T,R,Q,P,W,U,J,N,Z,S,V,H,M,L,G;if(typeof W!=="undefined"&&W!==null){W=I;return}V=this.particles;L=new THREE.Vector3();if(c!=null){for(R=0,U=Y.length;R<U;R++){K=Y[R];Z=K.normal;L.copy(Z).normalize().multiplyScalar(Z.dot(F));V[K.a].addForce(L);V[K.b].addForce(L);V[K.c].addForce(L)}}X=new THREE.Vector3();for(Q=0,J=V.length;Q<J;Q++){S=V[Q];X.copy(g).multiplyScalar(this.mass);S.addForce(X);S.integrate(d,this.drag)}M=[];for(T=P=0;P<1;T=++P){E=this.constrains;for(T=N=0,H=E.length-1;0<=H?N<=H:N>=H;T=0<=H?++N:--N){O=E[T];this.satisfyConstrains(O[0],O[1],O[2])}M.push((function(){var ac,aa,ab;ab=[];for(T=ac=0,aa=t.length-1;0<=aa?ac<=aa:ac>=aa;T=0<=aa?++ac:--ac){G=t[T];S=V[G];S.position.copy(S.original);ab.push(S.previous.copy(S.original))}return ab})())}return M};h.prototype.satisfyConstrains=function(I,H,J){var E,F,G;this.diff.subVectors(H.position,I.position);G=this.diff.length();if(G===0){return}E=this.diff.multiplyScalar(1-J/G);F=E.multiplyScalar(0.5);I.position.add(F);return H.position.sub(F)};return h})();D=(function(){h.prototype.position=void 0;h.prototype.previous=void 0;h.prototype.original=void 0;h.prototype.a=void 0;h.prototype.mass=0;h.prototype.invmass=0;h.prototype.tmp=void 0;h.prototype.tmp2=void 0;function h(E,F){this.position=new THREE.Vector3().copy(E);this.previous=new THREE.Vector3().copy(E);this.original=new THREE.Vector3().copy(E);this.a=new THREE.Vector3(0,0,0);this.mass=F;this.invmass=F===0?F:1/F;this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3()}h.prototype.addForce=function(E){this.tmp2.copy(E).multiplyScalar(this.invmass);return this.a.add(this.tmp2)};h.prototype.integrate=function(E,G){var F;F=this.tmp.subVectors(this.position,this.previous);F.multiplyScalar(G).add(this.position);F.add(this.a.multiplyScalar(E));this.tmp=this.previous;this.previous=this.position;this.position=F;return this.a.set(0,0,0)};return h})();e=function(){v.aspect=window.innerWidth/window.innerHeight;v.updateProjectionMatrix();return q.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",e,false);p=function(){var h;h=new Stats();h.setMode(0);h.domElement.style.position="absolute";h.domElement.style.left="0px";h.domElement.style.top="0px";return h};n=function(){var h,E,F;F=new THREE.Scene();h=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);h.position.x=-300;h.position.y=400;h.position.z=300;h.lookAt(F.position);E=new THREE.WebGLRenderer({antialias:true});E.setPixelRatio(window.devicePixelRatio);E.setClearColor(15658734);E.setSize(window.innerWidth,window.innerHeight);E.shadowMap.enabled=true;return{scene:F,camera:h,renderer:E}};o=new dat.GUI();o.add(r,"wireframe").onChange();w=o.addFolder("Wind Force");w.add(c,"x",-10,20);w.add(c,"y",-10,20);w.add(c,"z",-10,20);A=p();document.getElementById("stats-output").appendChild(A.domElement);i=n(),z=i.scene,v=i.camera,q=i.renderer;document.body.appendChild(q.domElement);f=new THREE.DirectionalLight(14674943,1.75);f.position.set(50,200,-100);f.castShadow=true;f.shadow.camera.near=2;f.shadow.camera.far=1000;f.shadow.camera.left=-500;f.shadow.camera.right=500;f.shadow.camera.top=500;f.shadow.camera.bottom=-500;f.shadow.mapSize.width=1024;f.shadow.mapSize.height=1024;z.add(f);x=new b(3,40,40);k=new THREE.MeshLambertMaterial({color:2274815,side:THREE.DoubleSide});y=new THREE.MeshBasicMaterial({color:16711680,wireframe:true});l=new THREE.ParametricGeometry(x.clothFunc,x.w,x.h);B=THREE.SceneUtils.createMultiMaterialObject(l,[k,y]);
    B.position.set(0,0,0);B.children[0].castShadow=true;z.add(B);m=new THREE.PlaneGeometry(1000,1000);j=new THREE.MeshLambertMaterial({color:15658734});a=new THREE.Mesh(m,j);a.position.set(0,-5,0);a.rotation.x=-Math.PI/2;a.receiveShadow=true;z.add(a);u=new THREE.AxisHelper(20);z.add(u);C=function(){var F,E,H,h,G;G=Date.now();x.simulate(G,l.faces,c);y.wireframe=r.wireframe;H=x.particles;for(F=E=0,h=H.length-1;0<=h?E<=h:E>=h;F=0<=h?++E:--E){l.vertices[F].copy(H[F].position)}l.computeFaceNormals();l.computeVertexNormals();l.normalsNeedUpdate=true;l.verticesNeedUpdate=true;A.update();requestAnimationFrame(C);return q.render(z,v)};C()}).call(this);