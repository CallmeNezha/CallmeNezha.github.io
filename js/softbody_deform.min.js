//              ______    _____            _________       _____   _____
//            /     /_  /    /            \___    /      /    /__/    /
//           /        \/    /    ___        /    /      /            /    ___
//          /     / \      /    /\__\      /    /___   /    ___     /    /   \
//        _/____ /   \___ /    _\___     _/_______ / _/___ / _/___ /    _\___/\_
//        revised on 5/27/2016  All rights reserved by @NeZha

(function(){var n,c,i,q,r,p,l,m,e,g,h,a,d,j,f,o,s,t,k,b=[].indexOf||function(w){for(var v=0,u=this.length;v<u;v++){if(v in this&&this[v]===w){return v}}return -1};p={compressSpeed:1,eps:0.000001,stiffness:0.25,shapeStiff:0.17,shapeStretch:false,generateGeometryFromBufferGeometry:function(C){var D,F,w,L,H,B,A,y,x,z,u,K,J,I,G,E;L=C.attributes.position.array;H=new THREE.Geometry();E=H.vertices;w=H.faces;D=function(M,v){if(Math.abs(M.x-v.x)>p.eps){return false}if(Math.abs(M.y-v.y)>p.eps){return false}if(Math.abs(M.z-v.z)>p.eps){return false}return true};for(B=y=0,u=L.length;y<u;B=y+=9){J=new THREE.Vector3(L[B],L[B+1],L[B+2]);I=new THREE.Vector3(L[B+3],L[B+4],L[B+5]);G=new THREE.Vector3(L[B+6],L[B+7],L[B+8]);F={};for(A=x=0,z=E.length;x<z;A=++x){K=E[A];if(D(J,K)===true){F.a=A}if(D(I,K)===true){F.b=A}if(D(G,K)===true){F.c=A}}if(F.a===void 0){E.push(J);F.a=E.length-1}if(F.b===void 0){E.push(I);F.b=E.length-1}if(F.c===void 0){E.push(G);F.c=E.length-1}w.push(new THREE.Face3(F.a,F.b,F.c))}return H},getE:function(u,v,w){return u.elements[v+w*3]},setE:function(u,v,x,w){return u.elements[v+x*3]=w},getRow:function(v,w,u){if(b.call([0,1,2],w)>=0){u.x=v.elements[w];u.y=v.elements[w+3];return u.z=v.elements[w+6]}},getColumn:function(w,x,u){var v;if(b.call([0,1,2],x)>=0){v=x*3;u.x=w.elements[v];u.y=w.elements[v+1];return u.z=w.elements[v+2]}},setRow:function(v,w,u){if(b.call([0,1,2],w)>=0){v.elements[w]=u.x;v.elements[w+3]=u.y;return v.elements[w+6]=u.z}},setColumn:function(w,x,u){var v;if(b.call([0,1,2],x)>=0){v=x*3;w.elements[v]=u.x;w.elements[v+1]=u.y;return w.elements[v+2]=u.z}},multiplyMatrices:function(B,A,E){var y,x,u,z,D,C;D=new THREE.Vector3();C=new THREE.Vector3();z=[];for(y=u=0;u<3;y=++u){D.set(B.elements[y],B.elements[y+3],B.elements[y+6]);z.push((function(){var v,w;w=[];for(x=v=0;v<9;x=v+=3){C.set(A.elements[x],A.elements[x+1],A.elements[x+2]);w.push(E.elements[y+x]=D.dot(C))}return w})())}return z},polarDecompositionStable:function(G,S,A){var U,u,w,y,H,Q,T,x,N,z,v,V,F,O,E,L,K,J,P,I,D,C,B;N=new THREE.Matrix3().copy(G).transpose();x=p.oneNorm(G);T=p.infNorm(G);Q=new THREE.Matrix3();u=new THREE.Matrix3();D=new THREE.Vector3();C=new THREE.Vector3();B=new THREE.Vector3();U=x*S+1;while(U>x*S){this.getRow(N,1,D);this.getRow(N,2,C);D.cross(C);this.setRow(Q,0,D);this.getRow(N,2,D);this.getRow(N,0,C);D.cross(C);this.setRow(Q,1,D);this.getRow(N,0,D);this.getRow(N,1,C);D.cross(C);this.setRow(Q,2,D);this.getRow(N,0,D);this.getRow(Q,0,C);z=D.dot(C);if(Math.abs(z)<1e-12){E=void 0;for(O=K=0;K<=2;O=++K){this.getRow(Q,O,D);P=D.lengthSq();if(P>1e-12){E=O;break}}if(E===void 0){A.identity();return}else{this.getRow(N,(E+1)%3,D);this.getRow(N,(E+2)%3,C);D.cross(C);this.setRow(N,E,D);this.getRow(N,(E+2)%3,D);this.getRow(N,E,C);D.cross(C);this.setRow(N,(E+1)%3,D);this.getRow(N,E,D);this.getRow(N,(E+1)%3,C);D.cross(C);this.setRow(N,(E+2)%3,D);w=new THREE.Matrix3();w.copy(N).transpose();x=this.oneNorm(w);T=this.infNorm(w);this.getRow(N,0,D);this.getRow(Q,0,C);z=D.dot(C)}}H=this.oneNorm(Q);y=this.infNorm(Q);F=Math.sqrt(Math.sqrt((H*y)/(x*T))/Math.abs(z));v=F*0.5;V=0.5/(F*z);for(O=J=0;J<=2;O=++J){for(L=I=0;I<=2;L=++I){this.setE(u,O,L,this.getE(N,O,L));this.setE(N,O,L,v*this.getE(N,O,L)+V*this.getE(Q,O,L));this.setE(u,O,L,this.getE(u,O,L)-this.getE(N,O,L))}}U=this.oneNorm(u);x=this.oneNorm(N);T=this.infNorm(N)}return A.copy(N).transpose()},oneNorm:function(x){var z,w,u,y,v;z=x.elements;v=[];for(w=u=0,y=z.length;u<y;w=u+=3){v.push(Math.abs(z[w])+Math.abs(z[w+1])+Math.abs(z[w+2]))}return Math.max.apply(Math,v)},infNorm:function(x){var y,w,u,v;y=x.elements;v=[];for(w=u=0;u<=2;w=++u){v.push(Math.abs(y[w])+Math.abs(y[w+3])+Math.abs(y[w+6]))}return Math.max.apply(Math,v)},computeVolume:function(B,C){var z,x,u,G,F,E,y,w,v,D,A;v=new THREE.Vector3();D=new THREE.Vector3();u=new THREE.Vector3();y=new THREE.Vector3(0,0,0);A=0;for(z=x=0,w=C.length;x<w;z=x+=3){G=B[C[z]].position;F=B[C[z+1]].position;E=B[C[z+2]].position;y.addVectors(G,F).add(E);v.subVectors(F,G);D.subVectors(E,G);u.crossVectors(v,D);A+=y.dot(u)}return A/=18},computeVolumeTHREE:function(C,x){var A,y,u,G,F,E,z,w,v,D,B;v=new THREE.Vector3();D=new THREE.Vector3();u=new THREE.Vector3();z=new THREE.Vector3(0,0,0);B=0;for(A=y=0,w=x.length;0<=w?y<w:y>w;A=0<=w?++y:--y){G=C[x[A].a];F=C[x[A].b];E=C[x[A].c];z.addVectors(G,F).add(E);v.subVectors(F,G);D.subVectors(E,G);u.crossVectors(v,D);B+=z.dot(u)}return B/=18},generateTopologyModelTHREE:function(x,u){var z,y,v,w,A;A=(function(){var B,D,C;C=[];for(y=B=0,D=x.length;0<=D?B<D:B>D;y=0<=D?++B:--B){C.push([])}return C})();for(y=v=0,w=u.length;v<w;y=++v){z=u[y];A[z.a].push(y);A[z.b].push(y);A[z.c].push(y)}return A},computeWeighedNorms:function(L,C,y){var F,G,J,I,E,D,B,u,x,w,v,A,H,z,K;A=new THREE.Vector3();H=new THREE.Vector3();B=new THREE.Vector3();K=[];for(J=0,E=L.length;J<E;J++){z=L[J];u=new THREE.Vector3(0,0,0);for(I=0,D=z.length;I<D;I++){G=z[I];F=y[G];x=C[F.a];w=C[F.b];v=C[F.c];A.subVectors(w,x);H.subVectors(v,x);B.crossVectors(A,H);u.add(B)}u.multiplyScalar(0.5);
    K.push(u)}return K},computeVolumeByWeighedNorms:function(B,y){var z,w,x,u,A;A=0;for(z=w=0,x=y.length;w<x;z=++w){u=y[z];A+=u.dot(B[z])}return A/=9},computeVolumeConstrain:function(J,L,A,v,z){var G,y,M,D,F,I,H,C,B,K,x,E,u;K=z!=null?z.localWeights.localWeights:void 0;u=p.computeWeighedNorms(L,A,v);D=p.computeVolumeByWeighedNorms(u,A);F=D-J;x=0;for(I=0,C=u.length;I<C;I++){E=u[I];x+=E.lengthSq()}G=Math.abs(x)>p.eps?F*3/x:0;if(x===0){console.warn("scope "+this+': normSq appear 0, please check function "computeVolumeConstrain"')}M=[];for(H=0,B=u.length;H<B;H++){E=u[H];y=new THREE.Vector3().copy(E);y.multiplyScalar(-G);M.push(y)}return M},initShapeMatching:function(M,u,K){var H,x,J,I,D,C,y,N,F,L,B,z,w,G,E;u.set(0,0,0);H=new THREE.Matrix3();H.set.apply(H,[0,0,0,0,0,0,0,0,0]);K.set.apply(K,[0,0,0,0,0,0,0,0,0]);for(J=0,D=M.length;J<D;J++){F=M[J];u.add(F)}u.multiplyScalar(1/M.length);y=new THREE.Vector3(0,0,0);for(I=0,C=M.length;I<C;I++){F=M[I];y.subVectors(F,u);L=y.x*y.x;w=y.y*y.y;E=y.z*y.z;B=y.x*y.y;z=y.x*y.z;G=y.y*y.z;H.elements[0]+=L;H.elements[3]+=B;H.elements[6]+=z;H.elements[1]+=B;H.elements[4]+=w;H.elements[7]+=G;H.elements[2]+=z;H.elements[5]+=G;H.elements[8]+=E}x=H.determinant();N=false;if(Math.abs(x)>p.eps){K.getInverse(H,N)}return N},computeShapeMatching:function(O,B,y,M,Q,w){var G,u,D,N,L,K,A,J,P,I,H,z,F,C,E;u=new THREE.Vector3(0,0,0);for(L=0,A=B.length;L<A;L++){E=B[L];u.add(E)}u.multiplyScalar(1/B.length);P=new THREE.Matrix3();P.set.apply(P,[0,0,0,0,0,0,0,0,0]);H=new THREE.Vector3(0,0,0);I=new THREE.Vector3(0,0,0);for(N=K=0,z=B.length;0<=z?K<z:K>z;N=0<=z?++K:--K){H.subVectors(O[N],y);I.subVectors(B[N],u);P.elements[0]+=I.x*H.x;P.elements[3]+=I.x*H.y;P.elements[6]+=I.x*H.z;P.elements[1]+=I.y*H.x;P.elements[4]+=I.y*H.y;P.elements[7]+=I.y*H.z;P.elements[2]+=I.z*H.x;P.elements[5]+=I.z*H.y;P.elements[8]+=I.z*H.z}C=new THREE.Matrix3();p.multiplyMatrices(P,M,C);P.copy(C);if(w===false){p.polarDecompositionStable(P,p.eps,C)}G=[];for(N=J=0,F=O.length;0<=F?J<F:J>F;N=0<=F?++J:--J){D=new THREE.Vector3().subVectors(O[N],y).applyMatrix3(C).add(u);D.sub(B[N]).multiplyScalar(Q);G.push(D)}return G},applyConstrains:function(z,A,B,y){var u,v,w,x;if(y==null){y=0}x=new THREE.Vector3().subVectors(z,A);w=x.length();if(w===0){return}u=x.multiplyScalar(1-B/w);v=u.multiplyScalar(0.5).multiplyScalar(1-Math.pow(1-this.stiffness,1/(y+1)));A.add(v);return z.sub(v)}};c=(function(){function u(v,B,A,w){this.previous=new THREE.Vector3(v,B,A);this.position=new THREE.Vector3(v,B,A);this.original=new THREE.Vector3(v,B,A);this.velocity=new THREE.Vector3(0,0,0);this.tmp=new THREE.Vector3();this.tmp2=new THREE.Vector3();this.mass=w;this.invmass=this.mass===0?0:1/this.mass;this.a=new THREE.Vector3(0,0,0)}u.prototype.addForce=function(v){this.tmp.copy(v).multiplyScalar(this.invmass);return this.a.add(this.tmp)};u.prototype.integrate=function(v,w){var x;x=this.tmp2;this.velocity.add(this.a.multiplyScalar(v));x.copy(this.velocity).multiplyScalar(w*v).add(this.position);this.tmp2=this.previous;this.previous=this.position;this.position=x;return this.a.set(0,0,0)};return u})();n=(function(){function u(z,A){var x,y,B,w;this.particleMass=A/8;this.particleInvmass=this.particleMass===0?0:1/this.particleMass;this.particles=[];for(x=0,y=z.length;x<y;x++){w=z[x];B=w.position;this.particles.push(new c(B.x,B.y,B.z,this.particleMass))}}u.prototype.addVolumeConstrain=function(){};return u})();d=function(){r.aspect=window.innerWidth/window.innerHeight;r.updateProjectionMatrix();return o.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",d,false);m=function(){var u;u=new Stats();u.setMode(0);u.domElement.style.position="absolute";u.domElement.style.left="0px";u.domElement.style.top="0px";return u};l=function(){var v,u,w,x;x=new THREE.Scene();v=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);v.position.x=-30;v.position.y=40;v.position.z=30;v.lookAt(x.position);w=new THREE.WebGLRenderer({antialias:true});w.setPixelRatio(window.devicePixelRatio);w.setClearColor(15658734);w.setSize(window.innerWidth,window.innerHeight);w.shadowMap.enabled=false;u=new THREE.OrbitControls(v);u.autoRotate=false;return{scene:x,camera:v,renderer:w,orbitControls:u}};t=m();document.getElementById("stats-output").appendChild(t.domElement);f=l(),s=f.scene,r=f.camera,o=f.renderer,j=f.orbitControls;document.body.appendChild(o.domElement);s.add(new THREE.AmbientLight(11184810,1));e=new THREE.DirectionalLight(14674943,0.4);e.position.set(-100,100,30);s.add(e);q=new THREE.AxisHelper(20);s.add(q);a=void 0;h=new THREE.STLLoader();k=new THREE.MeshNormalMaterial({color:"#99CCFF",roughness:1,metalness:0.5});g=function(A){var z,x,y,w,u;z=p.generateGeometryFromBufferGeometry(A);a=new THREE.Mesh(z,k);a.position.set(0,0,-10);a.rotation.set(0,0,-Math.PI/2.8);a.scale.set(0.3,0.3,0.3);a.updateMatrixWorld();w=z.vertices;for(x=0,y=w.length;x<y;x++){u=w[x];u.applyMatrix4(a.matrixWorld)}a.rotation.set(0,0,0);a.scale.set(1,1,1);a.position.set(0,0,0);z.computeFaceNormals();
    z.computeVertexNormals();s.add(a);A.dispose();return i()};h.load("../models/马里奥.stl",g);i=function(){var z,R,E,ad,P,ab,T,S,Q,I,ac,W,aa,M,Z,Y,F,D,y,K,O,C,X,L,H,G,N,ae,A,B,w,U,af,u,V,x,J;I=a.geometry;J=[];H=I.vertices;for(Z=0,F=H.length;Z<F;Z++){V=H[Z];J.push(new THREE.Vector3().copy(V))}ae=new THREE.Vector3();M=new THREE.Matrix3();p.initShapeMatching(I.vertices,ae,M);ac=p.generateTopologyModelTHREE(I.vertices,I.faces);x=p.computeWeighedNorms(ac,I.vertices,I.faces);A=p.computeVolumeByWeighedNorms(x,I.vertices);O=new THREE.MeshStandardMaterial({color:16777215,side:THREE.DoubleSide,roughness:1,metalness:0});R=new THREE.MeshStandardMaterial({color:16777215,roughness:1,metalness:0});B=new THREE.TextureLoader();B.load("../textures/brick_diffuse.jpg",function(v){v.wrapS=THREE.RepeatWrapping;v.wrapT=THREE.RepeatWrapping;v.anisotropy=4;v.repeat.set(1,1);O.map=v;O.needsUpdate=true;R.map=v;return R.needsUpdate=true});B.load("../textures/brick_bump.jpg",function(v){v.wrapS=THREE.RepeatWrapping;v.wrapT=THREE.RepeatWrapping;v.anisotropy=4;v.repeat.set(1,1);O.bumpMap=v;O.needsUpdate=true;R.bumpMap=v;return R.needsUpdate=true});B.load("../textures/brick_roughness.jpg",function(v){v.wrapS=THREE.RepeatWrapping;v.wrapT=THREE.RepeatWrapping;v.anisotropy=4;v.repeat.set(1,1);O.roughnessMap=v;O.needsUpdate=true;R.roughnessMap=v;return R.needsUpdate=true});z=new THREE.BoxGeometry(6,50,50);E=new THREE.Mesh(z,R);E.position.set(+7+3,0,0);s.add(E);B=void 0;y=new THREE.PlaneGeometry(36,36);O.transparent=true;O.opacity=0.1;C=new THREE.Mesh(y,O);L=new THREE.PlaneGeometry(50,20);K=new THREE.Mesh(L,O);X=new THREE.Mesh(L,O);C.rotation.x=Math.PI/2;K.rotation.y=Math.PI/2;X.rotation.y=Math.PI/2;C.position.set(0,15,10);K.position.set(-15,0,0);X.position.set(+7,0,0);s.add(K);s.add(X);U=new THREE.Vector3(0,0,0);W=new dat.GUI();aa=W.addFolder("Plane Y Postion");aa.add(C.position,"y",0,15);aa.open();aa=W.addFolder("Coeffience");aa.add(p,"stiffness",0,1);aa.add(p,"shapeStiff",0,1);aa.add(p,"shapeStretch").onChange();u=function(){var al,aj,ag,ah,v,ai,ak;ak=new THREE.Vector3();v=I.vertices;ai=[];for(ag=0,ah=v.length;ag<ah;ag++){V=v[ag];aj=THREE.Math.clamp(V.y,-3,C.position.y);V.y=aj;al=THREE.Math.clamp(V.x,K.position.x,X.position.x);V.x=al;if(V.y<-3){ai.push(V.y=-3)}else{ai.push(void 0)}}return ai};P=[];w=new THREE.Vector3();G=I.faces;for(Y=0,D=G.length;Y<D;Y++){ab=G[Y];T=I.vertices[ab.a];S=I.vertices[ab.b];Q=I.vertices[ab.c];P.push([T,S,w.subVectors(T,S).length()]);P.push([T,Q,w.subVectors(T,Q).length()]);P.push([S,Q,w.subVectors(S,Q).length()])}af=function(){var ah,ag,v,ai;ai=[];for(v=0,ag=P.length;v<ag;v++){ah=P[v];ai.push(p.applyConstrains(ah[1],ah[0],ah[2]))}return ai};ad=new THREE.Clock();N=function(){var ah,ap,aq,al,ak,ai,aj,ag,v,ao,an,am;aq=ad.getDelta();j.update(aq);K.position.x=-Math.sin(ad.getElapsedTime())*13-10;u();x=p.computeWeighedNorms(ac,I.vertices,I.faces);am=p.computeVolumeByWeighedNorms(x,I.vertices);ah=p.computeVolumeConstrain(A,ac,I.vertices,I.faces);ao=I.vertices;for(al=aj=0,ak=ao.length;aj<ak;al=++aj){V=ao[al];V.add(ah[al])}for(al=ag=0;ag<2;al=++ag){ap=p.computeShapeMatching(J,I.vertices,ae,M,p.shapeStiff,p.shapeStretch);an=I.vertices;for(al=v=0,ai=an.length;v<ai;al=++v){V=an[al];V.add(ap[al])}}af();I.computeFaceNormals();I.computeVertexNormals();I.normalsNeedUpdate=true;I.verticesNeedUpdate=true;t.update();requestAnimationFrame(N);return o.render(s,r)};document.getElementById("loading").style.display="none";return N()}}).call(this);